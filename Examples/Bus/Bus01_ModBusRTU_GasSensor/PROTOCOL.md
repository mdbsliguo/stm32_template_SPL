# 6合一气体传感器通信协议文档

## 硬件连接

将传感器的 **+、-、R、T** 分别接至用户的 **5V、GND、TXD、RXD**。

**注意**：用户端须使用 **TTL 电平**，如果是RS232电平，须进行转换。

## 串口参数

- **波特率**：9600
- **数据位**：8位
- **停止位**：1位
- **奇偶校验位**：无

## 通信协议

传感器支持两种通信协议：

1. **标准Modbus-RTU协议**（推荐，问询上报模式）
2. **简易协议**（兼容其他厂家协议，不推荐）

---

## 一、标准Modbus-RTU协议（推荐）

### 1.1 协议格式

- **地址码**：1字节，传感器地址（1～255），出厂默认0x01
- **功能码**：1字节，本传感器使用0x03（读取寄存器数据）
- **数据区**：N字节，16bits数据高字节在前
- **CRC码**：2字节，低位在前高位在后

### 1.2 主机问询帧结构

| 地址码 | 功能码 | 寄存器起始地址 | 寄存器长度 | 校验码低位 | 校验码高位 |
|--------|--------|----------------|------------|------------|------------|
| 1字节  | 1字节  | 2字节          | 2字节      | 1字节      | 1字节      |

**示例查询命令**：`01 03 00 00 00 0A C5 CD`
- `01`：传感器地址
- `03`：功能码（读取寄存器）
- `00 00`：起始寄存器地址（0x0000）
- `00 0A`：寄存器数量（10个寄存器）
- `C5 CD`：CRC校验码

### 1.3 传感器应答帧结构

| 地址码 | 功能码 | 有效字节数 | 数据一区 | 第二数据区 | ... | 第N数据区 | 校验码 |
|--------|--------|------------|----------|------------|-----|-----------|--------|
| 1字节  | 1字节  | 1字节      | 2字节    | 2字节      | ... | 2字节     | 2字节  |

**示例响应**：`01 03 14 00 00 00 00 00 64 01 2C 07 D0 00 05 00 00 00 00 45 00 00 00 00 B6 87`

**数据解析**：
1. `01`：传感器地址
2. `03`：读取数据
3. `14`：数据个数（20字节，不包括CRC）
4. `00 00`：寄存器0 - 数值单位和小数点位数
5. `00 00`：寄存器1 - 当前气体浓度为0
6. `00 64`：寄存器2 - 低报警阀值为100
7. `01 2C`：寄存器3 - 高报警阀值为300
8. `07 D0`：寄存器4 - 气体量程为2000
9. `00 05`：寄存器5 - 传感器工作状态（0x05为低报状态）
10. `00 00`：寄存器6 - 传感器实时AD值
11. `00 00`：寄存器7 - 环境温度值（25.5℃ = (数值-500)/10）
12. `45 00`：寄存器8 - 气体类型（0x45=69，PH3气体）
13. `00 00`：寄存器9 - 环境湿度值（60.8% = 数值/10）
14. `B6 87`：CRC校验码

### 1.4 10个寄存器映射关系

| 寄存器序号 | 逻辑地址（16进制） | 寄存器数值说明 | 备注 |
|-----------|-------------------|----------------|------|
| 0 | 0x00 0x00 | 数值单位和小数点位数 | Bit15-12:单位，Bit11-8:小数点 |
| 1 | 0x00 0x01 | 当前气体浓度 | |
| 2 | 0x00 0x02 | 低报设定值 | |
| 3 | 0x00 0x03 | 高报设定值 | |
| 4 | 0x00 0x04 | 全量程值 | |
| 5 | 0x00 0x05 | 传感器状态（低8位） | |
| 6 | 0x00 0x06 | 传感器实时AD值 | |
| 7 | 0x00 0x07 | 环境温度值 | (数值-500)/10 = 温度(℃) |
| 8 | 0x00 0x08 | 气体类型 | 高8位：气体类型编号 |
| 9 | 0x00 0x09 | 环境湿度 | 数值/10 = 湿度(%) |

### 1.5 寄存器0数值定义

**数值单位（Bit15-12）**：
- `0000`：ppm
- `0010`：%LEL
- `0100`：%VOL
- `0110`：mg/m³
- `1000`：ppb
- `1010`：℃

**小数点位数（Bit11-8）**：
- `0000`：无小数位
- `0100`：一位小数
- `1000`：两位小数
- `1100`：三位小数

### 1.6 状态字定义（寄存器05）

| 状态字 | 工作状态 | 状态字 | 工作状态 |
|--------|----------|--------|----------|
| 00 | 预热 | 08 | 超量程 |
| 01 | 正常 | 09 | 需要标定 |
| 02 | 数据错误 | 0A | 超时 |
| 03 | 传感器故障 | 0B | stel报警 |
| 04 | 预警 | 0C | twa报警 |
| 05 | 低报 | 0D | 保留 |
| 06 | 高报 | 0E | 保留 |
| 07 | 访问故障 | 0F | 通信故障 |

### 1.7 气体类型表（寄存器08高8位）

常见气体类型（10进制）：
- 0：NULL
- 5：CO
- 6：CO2
- 11：CH4
- 52：H2S
- 63：NH3
- 69：PH3
- 72：SO2
- ...（详见完整气体类型表）

### 1.8 多气体传感器轮询

**6合一气体传感器轮询命令**：
```
01 03 00 00 00 0A C5 CD  // 地址1
02 03 00 00 00 0A C5 FE  // 地址2
03 03 00 00 00 0A C4 2F  // 地址3
04 03 00 00 00 0A C5 98  // 地址4
05 03 00 00 00 0A C4 49  // 地址5
06 03 00 00 00 0A C4 7A  // 地址6
```

**注意**：多个不同地址传感器轮询时，建议每个地址问询3次，每次问询间隔500ms以上。



### 修改传感器地址

通过广播模式，设置传感器新地址。

| 超级命令改地址（红色为地址） |                                    |                                   |
| ---------------------------- | ---------------------------------- | --------------------------------- |
|                              | 发送                               | 返回                              |
| 查询                         | FF EE 01 CC 00 00 00  00 00 00 45  | FF  01 01 CC 00 01 00 00 00 00 31 |
| 设置：地址01                 | FF  EE 01 DD 00 01  00 00 00 00 33 | FF  01 01 DD 00 50 00 00 00 00 D1 |
| 设置：地址02                 | FF  EE 01 DD 00 02  00 00 00 00 32 | FF  01 02 DD 00 50 00 00 00 00 D0 |
| 设置：地址03                 | FF  EE 01 DD 00 03  00 00 00 00 31 | FF  01 03 DD 00 50 00 00 00 00 CF |
| 设置：地址04                 | FF  EE 01 DD 00 04  00 00 00 00 30 | FF  01 04 DD 00 50 00 00 00 00 CE |
| 设置：地址05                 | FF  EE 01 DD 00 05  00 00 00 00 2F | FF  01 05 DD 00 50 00 00 00 00 CD |
| 设置：地址06                 | FF  EE 01 DD 00 06  00 00 00 00 2E | FF  01 06 DD 00 50 00 00 00 00 CC |
| 设置：地址07                 | FF  EE 01 DD 00 07  00 00 00 00 2D | FF  01 07 DD 00 50 00 00 00 00 CB |
| 设置：地址08                 | FF  EE 01 DD 00 08  00 00 00 00 2C | FF  01 07 DD 00 50 00 00 00 00 CA |



---

## 二、简易协议（兼容其他厂家，不推荐）

### 2.1 读取气体浓度值（0x86）

**发送命令**：
```
FF 01 86 00 00 00 00 00 79
```

**返回值**：
```
FF 86 00 D1 00 00 00 00 A9
```

**数据解析**：
- 气体浓度值 = HIGH * 256 + LOW
- 示例：0x00 * 256 + 0xD1 = 209

### 2.2 校验和计算方法（LRC校验）

```
校验和 = (取反(Byte1+Byte2+Byte3+Byte4+Byte5+Byte6+Byte7)) + 1
```

**C语言计算例程**：
```c
char getCheckSum(char *packet)
{
    char i, checksum = 0;
    for(i = 1; i < 8; i++)
    {
        checksum += packet[i];
    }
    checksum = 0xff - checksum;
    checksum += 1;
    return checksum;
}
```

### 2.3 切换通信模式

**切换到主动上传模式**：
```
FF 01 78 03 00 00 00 00 84
```

**切换到问答模式**：
```
FF 01 78 04 00 00 00 00 83
```

---

## 三、CRC校验计算（Modbus-RTU）

Modbus-RTU使用CRC16校验，计算方式：

```c
uint16_t ModbusCRC16(uint8_t *data, uint16_t length)
{
    uint16_t crc = 0xFFFF;
    uint16_t i, j;
    
    for(i = 0; i < length; i++)
    {
        crc ^= data[i];
        for(j = 0; j < 8; j++)
        {
            if(crc & 0x0001)
            {
                crc = (crc >> 1) ^ 0xA001;
            }
            else
            {
                crc >>= 1;
            }
        }
    }
    
    return crc;
}
```

**注意**：CRC校验码在数据帧中**低位在前，高位在后**。

---

## 四、数据解析示例

### 4.1 温度值解析

寄存器7数值 = `0x00FE` (254)
- 温度 = (254 - 500) / 10 = -24.6℃

### 4.2 湿度值解析

寄存器9数值 = `0x0260` (608)
- 湿度 = 608 / 10 = 60.8%

### 4.3 气体浓度解析

寄存器1数值 = `0x00D1` (209)
- 根据寄存器0的单位定义，如果单位是ppm，则浓度为209ppm

---

## 五、注意事项

1. **6合一传感器**：需要轮询6个不同地址的传感器（地址1-6）
2. **轮询间隔**：建议每个地址问询间隔500ms以上
3. **重试机制**：建议每个地址问询3次，确保数据可靠性
4. **CRC校验**：必须正确计算和验证CRC，确保数据完整性
5. **数据格式**：16位数据高字节在前，CRC校验码低位在前
6. **测试方法**：开水放旁边测湿度、烧香测一氧化碳、吹气测二氧化碳、火机气体测甲烷、氢气没条件

