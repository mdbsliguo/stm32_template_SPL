# 5V转3.3V电平转换方案

## 📌 应用场景

BTS7960的R_IS引脚是**5V逻辑输出**（正常=低电平0V，过流=高电平5V），而STM32的GPIO是**3.3V逻辑输入**。如果直接将5V连接到STM32 GPIO，会损坏STM32！

**必须使用电平转换电路**，将5V转换为3.3V。

> **当前状态说明**：本案例当前未使用R_IS电流检测功能（`board.h`中配置为`NULL, 0`）。本文档是**备用方案**，如果将来需要使用R_IS引脚进行电流检测，可以参考本文档的电平转换方案。

---

## 🔧 方案1：分压电阻（推荐，最简单）

### 原理
使用两个电阻分压，将5V转换为约3.3V。

### 电路图
```
BTS7960 R_IS (5V输出) ──┬── R1 (10kΩ) ──┬── STM32 PA11 (3.3V输入)
                        │                │
                        └── R2 (20kΩ) ──┴── GND
```

### 计算公式
```
Vout = Vin × (R2 / (R1 + R2))
3.3V = 5V × (R2 / (R1 + R2))
R2 / (R1 + R2) = 3.3 / 5 = 0.66
```

### 推荐阻值
- **R1 = 10kΩ**（上拉电阻）
- **R2 = 20kΩ**（下拉电阻）
- **实际输出电压**：5V × (20k / (10k + 20k)) = **3.33V** ✅

### 优点
- ✅ 成本低（两个电阻）
- ✅ 电路简单
- ✅ 无需额外芯片
- ✅ 响应速度快

### 缺点
- ⚠️ 需要计算和选择合适阻值
- ⚠️ 功耗略高（有电流流过）

### 实际连接
```
BTS7960 R_IS (引脚5) ──┬── 10kΩ电阻 ──┬── STM32 PA11
                       │               │
                       └── 20kΩ电阻 ──┴── GND
```

### 注意事项
- 电阻精度：普通5%精度即可
- 电阻功率：1/4W或1/8W即可
- 如果BTS7960输出低电平(0V)，STM32读取为0V（正常）
- 如果BTS7960输出高电平(5V)，STM32读取为3.33V（安全）

---

## 🔧 方案2：专用电平转换芯片（多路信号推荐）

### 推荐芯片
- **TXB0104**：4路双向电平转换（5V ↔ 3.3V）
- **SN74LVC1T45**：单路双向电平转换
- **74LVC1T45**：单路双向电平转换（国产替代）

### TXB0104电路图（推荐）
```
BTS7960 R_IS (5V) ──> TXB0104 A1 (5V侧)
                      TXB0104 B1 (3.3V侧) ──> STM32 PA11
                      VCCA = 5V
                      VCCB = 3.3V
                      GND = 公共地
```

### 优点
- ✅ 多路信号转换（如需要转换R_IS和L_IS）
- ✅ 双向转换（如果需要）
- ✅ 隔离保护（保护STM32）
- ✅ 无需计算阻值

### 缺点
- ⚠️ 成本较高（芯片价格）
- ⚠️ 需要额外PCB空间

### 适用场景
- 需要转换多路信号（R_IS + L_IS）
- 需要双向转换
- 对可靠性要求高

---

## 🔧 方案3：齐纳二极管（不推荐）

### 原理
使用齐纳二极管（3.3V）将5V限制在3.3V。

### 电路图
```
BTS7960 R_IS (5V) ──┬── 齐纳二极管(3.3V) ──┬── STM32 PA11
                    │                      │
                    └── 限流电阻(1kΩ) ────┴── GND
```

### 缺点
- ⚠️ 需要精确的齐纳二极管
- ⚠️ 功耗较高
- ⚠️ 响应速度较慢
- ❌ 不推荐用于数字信号

---

## 🔧 方案4：MOSFET电平转换（复杂，不推荐）

### 原理
使用N沟道MOSFET进行电平转换。

### 缺点
- ⚠️ 电路复杂
- ⚠️ 需要额外元件
- ❌ 不推荐用于单路信号

---

## 📊 方案对比

| 方案 | 成本 | 复杂度 | 可靠性 | 推荐度 |
|------|------|--------|--------|--------|
| **分压电阻** | 极低 | 简单 | 高 | ⭐⭐⭐⭐⭐ |
| **电平转换芯片** | 中等 | 中等 | 很高 | ⭐⭐⭐⭐ |
| **齐纳二极管** | 低 | 中等 | 中 | ⭐⭐ |
| **MOSFET** | 低 | 复杂 | 中 | ⭐ |

---

## ✅ 推荐方案：分压电阻

### 完整连接图

```
                    ┌─────────────┐
                    │  BTS7960    │
                    │             │
                    │  R_IS (5V)  │──┐
                    │   (引脚5)    │  │
                    └─────────────┘  │
                                     │
                                     │ 5V输出
                                     │
                    ┌────────────────┴──┐
                    │  10kΩ电阻 (R1)     │
                    └────────────────┬──┘
                                     │
                                     │ 3.33V
                                     │
                    ┌────────────────┴──┐
                    │  STM32 PA11        │
                    │  (3.3V输入)        │
                    └────────────────────┘
                                     │
                    ┌────────────────┴──┐
                    │  20kΩ电阻 (R2)     │
                    └────────────────┬──┘
                                     │
                                    GND
```

### 元件清单
- **R1**：10kΩ电阻（1/4W或1/8W，5%精度）
- **R2**：20kΩ电阻（1/4W或1/8W，5%精度）

### 实际效果
- **BTS7960输出0V（正常）** → STM32读取**0V** ✅
- **BTS7960输出5V（过流）** → STM32读取**3.33V** ✅（安全，不会损坏STM32）

---

## ⚠️ 重要提示

1. **如果R_IS未连接**：
   - 在`board.h`中将R_IS配置为`NULL, 0`来禁用电流检测
   - 驱动代码已配置为下拉输入，未连接时读取低电平(0)，不会误报

2. **如果R_IS已连接**：
   - **必须使用电平转换电路**（推荐分压电阻）
   - 否则5V高电平会损坏STM32 GPIO！

3. **电平转换后**：
   - 正常时：BTS7960输出0V → STM32读取0V
   - 过流时：BTS7960输出5V → STM32读取3.33V（高电平，触发保护）

---

## 📝 总结

**最简单实用的方案**：使用**10kΩ + 20kΩ分压电阻**，成本低、电路简单、可靠性高。

**如果有多路信号需要转换**：使用**TXB0104电平转换芯片**。

