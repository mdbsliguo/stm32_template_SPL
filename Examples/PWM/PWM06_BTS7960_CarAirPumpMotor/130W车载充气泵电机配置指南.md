# 130W车载充气泵完整工程配置指南

> **⚠️ 重要说明**：本文档是**参考文档**，描述的是"130W车载充气泵完整工程"的配置方案，包含硬件过流保护、软启动、三档固定占空比等功能。
> 
> **当前案例（PWM06）**是"手动控制"案例，功能更简单：
> - 只使用旋转编码器连续调节占空比（0% ~ 100%）
> - 不使用按钮功能
> - 不使用硬件过流保护电路
> - 不使用R_IS电流检测
> - 引脚配置不同（UART1使用PA9/PA10，L_EN硬件接VCC）
> 
> 如需实现完整工程功能，可以参考本文档的配置方案。

## 1. 核心参数配置

### PWM三要素设定

| 参数 | 设定值 | 计算/配置方法 | 备注 |
|------|--------|---------------|------|
| 频率 | 20kHz | 周期=50μs（1秒÷20000） | 静音、低损耗、BTS7960最佳工作点 |
| 分辨率 | 10位 | 共1024级（0-1023） | 兼容性强，8位精度不足，12位浪费 |
| 占空比 | 三档：30%/50%/80% | 对应寄存器值：307/512/819 | 低速/中速/高速 |

**配置方式**：初始化时设置定时器周期值为1023（10位分辨率），运行时只需往比较寄存器写入307、512或819即可切换档位。

## 2. 硬件保护（必须实现）

### 过流保护（防止烧毁）

- **采样电阻**：0.01Ω, 5W功率（可用康铜丝自制）
- **运放放大**：50倍放大倍数 → 15A过流时输出7.5V
- **比较器**：LM393，阈值设定7.5V
- **响应时间**：硬件关断<10μs，远快于软件保护

**接线方法**：电机负极→采样电阻→GND，电阻两端电压经运放放大后接入比较器，比较器输出通过逻辑门（如74HC08与门）同时控制BTS7960的R_EN和L_EN引脚，过流时自动拉低两个使能引脚关断。

**注意**：BTS7960有两个使能引脚（R_EN和L_EN），必须同时为高电平才能工作，过流保护时需要同时拉低两个引脚。

### 死区时间（防桥臂直通）

BTS7960内部已集成死区保护，软件层面可配置死区时间作为额外保护。

**注意**：BTS7960使用两个独立PWM通道（RPWM和LPWM），不是互补通道。TIM1的死区时间功能仅适用于互补通道（CH1/CH1N），对独立通道可能不生效。但代码中已配置2μs死区时间，即使不生效也不影响功能（BTS7960内部已有保护）。

**建议**：对于充气泵单向应用，可只使用RPWM通道，LPWM保持为0，这样更简单可靠。

### 软启动（防冲击电流）

**实现方式**：从0%占空比开始，每10ms增加10%，用100ms时间缓慢爬升到目标值（如30%），可将启动电流从50A降至15A以内。

### 散热配置

- **散热片**：5cm×5cm铝散热片配3cm风扇
- **发热计算**：11A工作电流下，BTS7960功耗约1.9W（11²×0.016Ω），必须散热

## 3. 软件流程逻辑

### 初始化阶段（仅执行一次）：

1. 配置定时器为PWM模式，频率20kHz，分辨率10位
2. 配置过流比较器阈值7.5V
3. 使能定时器输出

### 运行阶段（循环执行）：

1. 检测按键/旋钮状态
2. **占空比控制方案**（二选一）：
   - **方案A（连续调节）**：旋钮直接控制占空比0-100%，实时写入比较寄存器（当前代码实现）
   - **方案B（三档固定）**：按键切换档位，向比较寄存器写入307（低速30%）、512（中速50%）或819（高速80%）
3. 实时检测电流和温度，超限立即调用`BTS7960_SetDirection(BTS7960_DIR_STOP)`停止输出（软件保护）
4. 硬件过流保护：比较器自动拉低R_EN和L_EN，响应时间<10μs（硬件保护）

## 4. 故障现象速查表

| 现象 | 检查频率 | 检查占空比 | 检查保护电路 | 根本原因 |
|------|----------|------------|--------------|----------|
| 电机不转 | 是否<1kHz? | 是否0%? | 过流保护是否误触发? | PWM无输出 |
| 电机啸叫 | 是否20kHz? | 正常 | 无关 | 频率过低 |
| 压力表抖动 | 正常 | PID参数 | 分辨率是否<10位? | 占空比跳档 |
| 驱动烧毁 | 正常 | 正常 | 过流保护未加! | 堵转50A炸管 |

## 5. 接线关系文字图

### STM32侧：

> **注意**：以下引脚配置是**完整工程**的配置方案，与当前案例（PWM06）不同：
> - 当前案例：UART1使用PA9/PA10（标准配置），L_EN硬件接VCC（5V），不使用LPWM
> - 完整工程：PA9用于LPWM，PA7用于L_EN（STM32控制）

- PA8（TIM1_CH1）→ BTS7960 RPWM输入（正转PWM）✅ **与当前案例一致**
- PA9（TIM1_CH2）→ BTS7960 LPWM输入（反转PWM，充气泵可不用，保持为0）⚠️ **当前案例：UART1 TX**
- PA5（GPIO）→ BTS7960 R_EN（正转使能）✅ **与当前案例一致**
- PA7（GPIO）→ BTS7960 L_EN（反转使能，充气泵可不用，但必须同时使能）⚠️ **当前案例：L_EN硬件接VCC（5V）**
- 5V → BTS7960 VCC供电（逻辑电源，不能接3.3V）✅ **与当前案例一致**
- GND → BTS7960 共地（必须与STM32共地）✅ **与当前案例一致**

### BTS7960侧：

- OUT → 电机正极
- GND → 电机负极→0.01Ω采样电阻→GND
- R_EN/L_EN → 通过逻辑门（74HC08）连接LM393比较器输出（过流时同时拉低）

**注意**：对于充气泵单向应用，建议只使用RPWM和R_EN，LPWM保持为0，L_EN与R_EN并联（必须同时为高电平才能工作）。

### 电流采样电路：

0.01Ω电阻两端 → LM358运放（50倍放大）→ LM393比较器

比较器阈值7.5V → 通过74HC08与门同时控制BTS7960的R_EN和L_EN引脚（过流时同时拉低关断）

**电路说明**：
- 正常时：比较器输出高电平，与门输出高电平，R_EN和L_EN同时为高，BTS7960工作
- 过流时：比较器输出低电平，与门输出低电平，R_EN和L_EN同时拉低，BTS7960立即关断

## 6. 最终工程建议

### 配置清单：

- **频率20kHz**：一次性设置，永不更改（固定值）
- **分辨率10位**：一次性设置，永不更改（ARR=1023，固定值）
- **占空比控制**：两种方案可选
  - **方案A**：旋钮连续调节0-100%（当前代码实现，灵活）
  - **方案B**：按键三档切换30%/50%/80%（对应寄存器值307/512/819，简单）
- **过流保护**：必须加，15A阈值+硬件关断（硬件比较器+软件检测双重保护）
- **软启动**：100ms缓启动，防冲击电流（可选，代码中可添加）
- **散热**：5cm散热片+风扇（必须，11A工作电流下功耗约1.9W）

### 懒人配置法：

STM32CUBEMX中设置TIM1为PWM Generation CH1，频率20kHz，计数周期1023，生成代码后只需在运行时写入307/512/819三个值即可。

## 总结

**频率分辨率配好锁死，用户只调占空比（连续或三档），保护电路做全，散热别省。**

## 重要说明

1. **BTS7960使能引脚**：R_EN和L_EN必须同时为高电平才能工作，过流保护时需要同时拉低两个引脚
2. **死区时间**：BTS7960使用独立通道，TIM1死区时间功能可能不生效，但BTS7960内部已有保护
3. **充气泵应用**：单向应用建议只使用RPWM通道，LPWM保持为0，简化控制
4. **占空比控制**：当前代码支持连续调节，如需三档固定值，可修改代码添加档位切换逻辑
5. **调试建议**：先验证基本功能（PWM输出、方向控制），再添加保护功能（过流检测、软启动）

