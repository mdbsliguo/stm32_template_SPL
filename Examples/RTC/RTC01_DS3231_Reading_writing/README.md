# RTC01 - DS3231读写时间示例

## 📋 案例目的

本案例的主要目的是：

- **核心目标**：演示如何使用DS3231实时时钟模块进行时间读写操作
- **学习重点**：
  - 理解DS3231初始化和配置流程
  - 掌握DS3231时间读取方法（`DS3231_ReadTime()`）
  - 掌握DS3231时间写入方法（`DS3231_SetTime()`）
  - 学习OSF（振荡器停止标志）的检查和清除
  - 理解DS3231时间格式和星期编码规则
- **应用场景**：适用于需要实时时钟功能的应用，如数据记录、定时任务、时钟显示等

## 🔧 硬件要求

### 必需外设

- **LED1**：`PA1`（系统状态指示）

### 传感器/模块

- **DS3231实时时钟模块**（I2C接口）
  - SCL：`PB10`（软件I2C）
  - SDA：`PB11`（软件I2C）
  - VCC：3.3V
  - GND：GND
  - **上拉电阻**：SCL和SDA需要4.7kΩ-10kΩ上拉到3.3V（I2C总线必需）

- **OLED显示屏**（SSD1306，软件I2C接口）
  - SCL：`PB8`（软件I2C）
  - SDA：`PB9`（软件I2C）
  - VCC：3.3V
  - GND：GND

**⚠️ 重要提示**：

1. **I2C上拉电阻必须添加**：DS3231的SCL和SDA线必须添加上拉电阻（4.7kΩ-10kΩ）到3.3V，否则I2C通信会失败
2. **引脚不冲突**：DS3231（PB10/11）和OLED（PB8/9）使用不同的I2C实例，不会冲突

## 📦 模块依赖

- `soft_i2c`：软件I2C驱动模块（DS3231使用软件I2C）
- `ds3231`：DS3231实时时钟驱动模块（核心）
- `gpio`：GPIO驱动模块（软件I2C依赖）
- `led`：LED驱动模块（状态指示）
- `oled`：OLED显示模块（默认显示器）
- `delay`：延时模块
- `TIM2_TimeBase`：TIM2时间基准模块（延时模块依赖）
- `system_init`：系统初始化模块

## 🔄 实现流程

### 整体逻辑

本案例演示DS3231的基本读写操作，整体流程如下：

1. **初始化阶段**
   - 系统初始化（时钟、GPIO等）
   - LED和OLED初始化
   - 软件I2C2初始化（用于DS3231）
   - DS3231初始化
   - 检查并清除OSF标志（如果存在）
   - 启动DS3231振荡器

2. **读取当前时间**
   - 调用 `DS3231_ReadTime()` 读取DS3231当前时间
   - 在OLED上显示读取到的当前时间
   - 停留2秒让用户查看

3. **写入新时间**
   - 设置时间结构体（2024-01-01 12:00:00 Monday）
   - 调用 `DS3231_SetTime()` 写入时间到DS3231
   - 显示写入成功提示

4. **循环显示时间**
   - 主循环中每秒调用 `DS3231_ReadTime()` 读取时间
   - 在OLED上实时显示日期和时间
   - LED闪烁指示系统运行

### 关键方法

- **先读后写策略**：先读取当前时间显示，再写入新时间，最后循环显示，符合实际应用流程
- **OSF标志处理**：初始化后检查OSF标志，如果存在则清除，确保时间准确性
- **错误处理**：每个关键操作都检查返回值，失败时显示错误信息并停止运行
- **实时显示**：使用延时模块的tick功能实现每秒更新，避免阻塞主循环

### 工作流程示意

```text
系统初始化
    ↓
LED和OLED初始化
    ↓
软件I2C2初始化（PB10/11）
    ↓
DS3231初始化
    ↓
检查并清除OSF标志
    ↓
启动DS3231振荡器
    ↓
读取当前时间并显示
    ↓
写入新时间（2024-01-01 12:00:00）
    ↓
主循环：每秒读取并显示时间
```

## 📚 关键函数说明

### DS3231相关函数

- **`DS3231_Init()`**：初始化DS3231模块
  - 在本案例中用于配置DS3231接口类型和I2C实例
  - 必须在使用其他DS3231函数前调用
  - 需要配置接口类型（软件I2C或硬件I2C）和对应的I2C实例

- **`DS3231_CheckOSF()`**：检查OSF（振荡器停止标志）
  - 在本案例中用于检测DS3231是否曾经断电或振荡器停止
  - OSF标志被设置时，时间可能不准确，需要重新设置时间

- **`DS3231_ClearOSF()`**：清除OSF标志
  - 在本案例中用于清除OSF标志，确保时间状态正常
  - 写入新时间后会自动清除OSF标志

- **`DS3231_Start()`**：启动DS3231振荡器
  - 在本案例中用于确保DS3231振荡器运行
  - 必须在设置时间前启动振荡器

- **`DS3231_ReadTime()`**：读取DS3231当前时间
  - 在本案例中用于读取DS3231的当前时间
  - 返回的时间结构体包含年、月、日、时、分、秒、星期
  - 星期编码：1=Sunday, 2=Monday, ..., 7=Saturday

- **`DS3231_SetTime()`**：设置DS3231时间
  - 在本案例中用于写入新时间到DS3231
  - 会自动进行参数校验（日期有效性、闰年检查等）
  - 写入成功后会自动清除OSF标志

### OLED相关函数

- **`OLED_Init()`**：初始化OLED显示模块
  - 在本案例中用于初始化OLED显示屏
  - 必须在使用其他OLED函数前调用

- **`OLED_ShowString()`**：显示字符串
  - 在本案例中用于显示提示信息和时间字符串

- **`OLED_ShowChar()`**：显示单个字符
  - 在本案例中用于清除行尾残留字符

### 软件I2C相关函数

- **`I2C_SW_Init()`**：初始化软件I2C实例
  - 在本案例中用于初始化SoftI2C2实例（PB10/11）
  - 必须在DS3231初始化前调用

**详细函数实现和调用示例请参考**：`main_example.c` 中的代码

## 🔗 相关文档

- [DS3231驱动模块文档](../../Drivers/sensors/ds3231.h)
- [软件I2C驱动模块文档](../../Drivers/i2c/i2c_sw.h)
- [OLED驱动模块文档](../../Drivers/display/oled_ssd1306.h)
- [主程序代码](main_example.c)
- [硬件配置](board.h)
- [模块配置](config.h)

## ⚠️ 注意事项与重点

### ⚠️ 重要提示

1. **I2C上拉电阻必须添加**
   - DS3231的SCL和SDA线必须添加上拉电阻（4.7kΩ-10kΩ）到3.3V
   - 否则I2C通信会失败，无法读取或写入时间

2. **OSF标志处理**
   - 如果DS3231曾经断电，OSF标志会被设置
   - 必须清除OSF标志后再使用，否则时间可能不准确
   - 写入新时间后会自动清除OSF标志

3. **时间格式必须正确**
   - 年：1900-2099
   - 月：1-12
   - 日：1-31（需要考虑月份天数和闰年）
   - 时：0-23（24小时制）
   - 分：0-59
   - 秒：0-59
   - 星期：1-7（1=Sunday, 2=Monday, ..., 7=Saturday）

### 🔑 关键点

1. **先读后写流程**
   - 本案例采用先读取当前时间、再写入新时间、最后循环显示的流程
   - 这样可以先了解DS3231的当前状态，再设置新时间

2. **星期编码规则**
   - DS3231使用1-7表示星期，1表示Sunday
   - 2024-01-01是Monday，所以weekday=2
   - 必须确保日期和星期匹配，否则显示会错误

3. **时间验证**
   - `DS3231_SetTime()` 函数会自动进行参数校验
   - 包括日期有效性检查（考虑闰年和月份天数）
   - 无效的时间会被拒绝，返回错误码

4. **实时显示实现**
   - 使用 `Delay_GetTick()` 和 `Delay_GetElapsed()` 实现非阻塞的定时更新
   - 每秒更新一次显示，避免频繁读取DS3231

5. **错误处理**
   - 所有关键操作都检查返回值
   - 失败时显示错误信息并停止运行
   - 便于快速定位问题

## 🔍 扩展练习

1. **修改写入时间**：修改代码中的时间设置，尝试写入不同的日期和时间
2. **添加温度显示**：使用 `DS3231_ReadTemperature()` 函数读取并显示温度
3. **实现时间校准**：通过按键或其他方式实现时间的手动校准功能
4. **添加闹钟功能**：使用 `DS3231_SetAlarm1()` 配置闹钟，实现定时提醒
5. **格式化显示优化**：优化OLED显示格式，添加更多信息（如温度、星期全称等）
6. **时间同步**：实现从外部源（如串口）接收时间并同步到DS3231

## 📚 相关模块

- **DS3231驱动**：`Drivers/sensors/ds3231.c/h`
- **软件I2C驱动**：`Drivers/i2c/i2c_sw.c/h`
- **OLED驱动**：`Drivers/display/oled_ssd1306.c/h`
- **LED驱动**：`Drivers/basic/led.c/h`
- **延时功能**：`system/delay.c/h`
- **系统初始化**：`system/system_init.c/h`
- **硬件配置**：案例目录下的 `board.h`

---

**最后更新**：2024-01-01
