# I2C03 - I2C中断模式用法示例

## 📋 案例目的

本案例的主要目的是：

- **核心目标**：演示如何使用硬件I2C中断模式进行非阻塞数据传输
- **学习重点**：
  - 理解I2C中断模式的配置和使用方法
  - 掌握I2C中断回调函数的编写
  - 理解中断模式的非阻塞特性和优势
  - 学习如何在中断回调中使用I2C中断模式读取数据
- **应用场景**：适用于需要高实时性、多任务并发的应用场景，如实时数据采集、多传感器读取等

## 🔧 硬件要求

### 必需外设

- **LED1**：`PA1`（系统状态指示）

### 传感器/模块

- **DS3231实时时钟模块**（I2C接口）
  - SCL：`PB10`（I2C2）
  - SDA：`PB11`（I2C2）
  - **INT/SQW：`PA0`（EXTI0，用于闹钟中断）⚠️ 必须连接**
  - VCC：3.3V
  - GND：GND
  - **上拉电阻**：
    - SCL和SDA需要4.7kΩ-10kΩ上拉到3.3V（I2C总线必需）
    - **INT/SQW引脚必须添加上拉电阻（10kΩ）到3.3V** ⚠️
      - DS3231的INT/SQW引脚是开漏输出，需要外部上拉电阻
      - 如果模块没有内置上拉电阻，必须外部添加，否则EXTI中断无法触发
      - 如果显示"Flag ON No IT"，说明EXTI中断未触发，请检查INT/SQW引脚连接和上拉电阻

- **OLED显示屏**（SSD1306，软件I2C接口）
  - SCL：`PB8`
  - SDA：`PB9`
  - VCC：3.3V
  - GND：GND

**⚠️ 重要提示**：
1. **INT/SQW引脚必须连接**：如果不连接PA0，闹钟触发时无法通过EXTI中断检测
2. **上拉电阻必须添加**：INT/SQW引脚必须添加上拉电阻（10kΩ）到3.3V，否则EXTI中断无法触发
3. **本案例必须通过EXTI中断触发**：不能使用轮询方式检测闹钟标志，必须通过EXTI中断触发

## 📦 模块依赖

- `i2c`：硬件I2C驱动模块（使用中断模式）
- `ds3231`：DS3231实时时钟驱动模块
- `exti`：外部中断模块（用于DS3231闹钟中断）
- `oled`：OLED显示驱动模块
- `led`：LED驱动模块
- `delay`：延时模块
- `error_handler`：错误处理模块
- `log`：日志模块

## 🔄 实现流程

### 整体逻辑

本案例通过DS3231闹钟中断触发，演示I2C中断模式的使用。整体流程如下：

1. **初始化阶段**（使用轮询模式）
   - 系统初始化（时钟、GPIO等）
   - I2C2初始化（默认轮询模式）
   - DS3231初始化（使用轮询模式配置，更稳定）
   - 配置DS3231闹钟（每30秒触发一次）
   - 配置EXTI0（检测DS3231 INT/SQW引脚下降沿）
   - 切换I2C2为中断模式（用于后续中断读取）

2. **主循环**（轮询模式读取，用于对比）
   - 每秒使用轮询模式读取DS3231时间并显示
   - 检查闹钟触发标志
   - LED闪烁指示系统运行

3. **中断处理**（中断模式读取，演示非阻塞特性）
   - EXTI0中断：检测到DS3231闹钟触发，设置标志位
   - 主循环检测到标志后，使用I2C中断模式读取时间
   - I2C中断：处理I2C传输完成事件，设置完成标志

### 关键方法

- **模式切换策略**：初始化时使用轮询模式（稳定），初始化完成后切换到中断模式（高效）
- **中断回调机制**：使用回调函数处理中断事件，通过标志位与主循环通信
- **非阻塞读取**：I2C中断模式读取数据时，函数立即返回，实际传输在中断中完成
- **超时保护**：等待I2C中断完成时设置超时，避免因通信失败导致死锁

### 工作流程示意

```text
初始化（轮询模式）
    ↓
配置DS3231闹钟（每30秒触发）
    ↓
配置EXTI0（检测INT/SQW引脚）
    ↓
切换I2C为中断模式
    ↓
主循环（每秒轮询读取时间）
    ↓
闹钟触发 → EXTI0中断 → 设置标志
    ↓
主循环检测标志 → I2C中断模式读取时间
    ↓
I2C中断完成 → 更新显示
```

## 📚 关键函数说明

### I2C相关函数

- **`I2C_SetTransferMode()`**：设置I2C传输模式（轮询/中断/DMA）
  - 必须在调用中断模式函数前设置
  - 可以动态切换模式

- **`I2C_SetCallback()`**：设置I2C中断回调函数
  - 回调函数在I2C传输完成时被调用
  - 用于处理传输完成事件和错误

- **`I2C_MasterTransmitIT()`**：中断模式发送数据（非阻塞）
  - 函数立即返回，实际传输在中断中完成
  - 需要等待完成标志或使用回调函数

- **`I2C_MasterReceiveIT()`**：中断模式接收数据（非阻塞）
  - 函数立即返回，实际传输在中断中完成
  - 需要等待完成标志或使用回调函数

### DS3231相关函数

- **`DS3231_SetAlarm1()`**：配置闹钟1
  - 支持多种匹配模式（秒匹配、分秒匹配等）
  - 本案例使用秒匹配模式，每30秒触发

- **`DS3231_EnableAlarm1()`**：使能闹钟1中断
  - 使能后，闹钟触发时INT/SQW引脚会输出低电平

- **`DS3231_ClearAlarm1Flag()`**：清除闹钟1标志
  - 读取闹钟标志后必须清除，否则无法再次触发

- **`DS3231_SetInterruptMode()`**：设置DS3231中断模式
  - 本案例使用`DS3231_INT_MODE_ALARM`（闹钟中断模式）

### EXTI相关函数

- **`EXTI_HW_Init()`**：初始化外部中断
  - 配置触发方式（上升沿/下降沿/双边沿）
  - 配置模式（中断/事件）

- **`EXTI_SetCallback()`**：设置EXTI中断回调函数
  - 回调函数在外部中断触发时被调用

- **`EXTI_Enable()`**：使能外部中断
  - 使能后，外部中断才能触发

**详细函数实现和调用示例请参考**：`main_example.c` 中的代码

## 🔗 相关文档

- [I2C驱动模块文档](../../Drivers/i2c/i2c_hw.h)
- [DS3231驱动模块文档](../../Drivers/sensors/ds3231.h)
- [EXTI驱动模块文档](../../Drivers/peripheral/exti.h)
- [主程序代码](main_example.c)
- [硬件配置](board.h)
- [模块配置](config.h)

## ⚠️ 注意事项与重点

### ⚠️ 重要提示

1. **INT/SQW引脚必须连接**
   - 如果不连接PA0，闹钟触发时无法通过EXTI中断检测
   - 程序会一直等待闹钟触发，无法正常工作

2. **上拉电阻必须添加**
   - I2C总线（SCL和SDA）必须添加上拉电阻（4.7kΩ-10kΩ）到3.3V
   - 否则I2C通信会失败

3. **中断优先级配置**
   - I2C中断优先级：1（抢占优先级），1（子优先级）
   - EXTI中断优先级：默认（通常高于I2C中断）
   - 确保中断优先级配置合理，避免中断嵌套问题

### 🔑 关键点

1. **模式切换时机**
   - DS3231初始化时使用轮询模式（更稳定可靠）
   - 初始化完成后切换到中断模式（用于闹钟触发时的读取）
   - 主循环中读取时间时，临时切换回轮询模式（简化代码）

2. **中断回调函数设计**
   - **保持简短**：中断回调函数应尽可能简短，避免长时间操作
   - **避免阻塞**：不要在中断回调中调用阻塞函数（如`Delay_ms`）
   - **标志位通信**：使用标志位与主循环通信，复杂逻辑在主循环中处理

3. **I2C中断模式使用流程**
   - 先设置传输模式为中断模式
   - 设置回调函数
   - 调用中断模式函数（立即返回）
   - 等待完成标志或使用回调函数处理

4. **超时保护**
   - 在等待I2C中断完成时，应设置超时保护
   - 避免因I2C通信失败导致程序死锁
   - 本案例使用`Delay_GetTick()`和`Delay_GetElapsed()`实现超时检测

5. **DS3231闹钟配置**
   - 本案例配置闹钟为每30秒触发一次（30秒、0秒）
   - 需要配置DS3231中断模式为闹钟中断（`DS3231_INT_MODE_ALARM`）
   - 需要使能闹钟中断（`DS3231_EnableAlarm1()`）
   - 读取闹钟标志后必须清除，否则无法再次触发

### 💡 调试技巧

#### 调试判断速查表

根据OLED显示和LED状态快速定位程序执行阶段和故障：

| OLED显示 | LED状态 | 阶段 | 故障排查 |
|---------|---------|------|---------|
| I2C03 | 无 | 程序开始 | 检查OLED初始化、系统初始化 |
| I2C2 Init Fail! | 快速闪烁 | I2C2初始化失败 | 检查I2C硬件连接、上拉电阻、I2C配置 |
| I2C2 OK | 无 | I2C2初始化成功 | - |
| DS3231 Init Fail! | 快速闪烁 | DS3231初始化失败 | 检查DS3231连接、I2C通信、模块供电 |
| DS3231 OK | 无 | DS3231初始化成功 | - |
| Clear Old Alarm | 无 | 清除旧闹钟配置 | 检查DS3231通信、闹钟寄存器 |
| Set Alarm Fail! | 快速闪烁 | 闹钟配置失败 | 检查闹钟参数、DS3231通信 |
| Alarm1 Set OK | 无 | 闹钟配置成功 | - |
| Enable Alarm Fail! | 快速闪烁 | 使能闹钟失败 | 检查DS3231控制寄存器、I2C通信 |
| Alarm1 Enabled | 无 | 闹钟使能成功 | - |
| Set INT Mode Fail! | 快速闪烁 | DS3231中断模式配置失败 | 检查DS3231控制寄存器、I2C通信 |
| INT Mode OK | 无 | DS3231中断模式配置成功 | - |
| EXTI Init Fail! | 快速闪烁 | EXTI初始化失败 | 检查EXTI配置、GPIO配置、PA0连接 |
| Set Callback Fail! | 快速闪烁 | EXTI回调设置失败 | 检查EXTI模块状态、回调函数 |
| Enable EXTI Fail! | 快速闪烁 | EXTI使能失败 | 检查EXTI配置、NVIC配置 |
| EXTI0 OK | 无 | EXTI0初始化成功 | - |
| Set IT Mode Fail! | 快速闪烁 | I2C中断模式设置失败 | 检查I2C状态、中断配置、NVIC配置 |
| Set Callback Fail! | 快速闪烁 | I2C回调设置失败 | 检查I2C模块状态、回调函数 |
| I2C IT Mode OK | 无 | I2C中断模式设置成功 | - |
| Mode Ready | 闪烁1次 | 初始化完成准备就绪 | - |
| Switch Poll... | 无 | 切换I2C为轮询模式 | 检查I2C状态、模式切换函数 |
| Reading Time... | 无 | 读取DS3231时间 | 检查I2C通信、DS3231状态 |
| Read Fail! | 无 | 时间读取失败 | 检查I2C通信、DS3231连接、上拉电阻 |
| Time OK | 闪烁1次 | 时间读取成功 | - |
| Switch IT... | 无 | 切换I2C为中断模式 | 检查I2C状态、模式切换函数 |
| IT Mode Fail! | 无 | I2C中断模式切换失败 | 检查I2C状态、中断配置 |
| IT Mode OK | 闪烁1次 | I2C中断模式切换成功 | - |
| Switch Mode... | 闪烁1次 | 准备切换I2C模式 | 检查I2C状态、中断处理完成 |
| Before Switch | 闪烁1次 | 切换前准备 | 检查I2C状态、等待中断完成 |
| Calling Switch | 闪烁1次 | 正在切换I2C模式 | 检查I2C_SetTransferMode函数、I2C状态机 |
| Switch Fail! | 快速闪烁 | I2C模式切换失败 | 检查I2C状态、中断配置、函数返回值 |
| Switch OK | 闪烁1次 | I2C模式切换成功 | - |
| Read Time... | 闪烁1次 | 读取时间准备 | 检查I2C模式、DS3231状态 |
| Read Time Fail! | 无 | 时间读取失败 | 检查I2C通信、DS3231连接、模式切换 |
| Wait Alarm... | 每2秒闪烁 | 主循环运行等待闹钟 | 检查主循环逻辑、时间读取函数、闹钟配置 |
| Alarm1 Flag ON! | 每2秒闪烁 | 主循环检测到闹钟标志 | 检查闹钟配置、EXTI中断、INT/SQW引脚 |
| Alarm Trigger! | 闪烁2次 | 闹钟触发中断读取 | 检查EXTI中断、I2C中断模式、回调函数 |
| I2C IT Read OK | 闪烁2次 | I2C中断模式读取成功 | - |

**使用说明**：

- 观察OLED显示的关键信息，对照表格快速定位程序执行阶段
- LED状态作为辅助观察信息，帮助确认程序流程
- 如果程序卡在某个阶段，参考"故障排查"列的建议进行排查
- 故障排查建议最多3项，按优先级排序

## 📊 模式对比

| 特性 | 轮询模式 | 中断模式 |
|------|---------|---------|
| **阻塞性** | 阻塞，等待传输完成 | 非阻塞，立即返回 |
| **CPU占用** | 高（等待期间CPU被占用） | 低（等待期间CPU可执行其他任务） |
| **响应性** | 较差（阻塞期间无法响应其他事件） | 较好（可同时处理多个事件） |
| **复杂度** | 简单 | 较复杂（需要回调函数和状态管理） |
| **适用场景** | 简单应用，对实时性要求不高 | 复杂应用，需要高实时性 |

## 📌 总结

I2C中断模式提供了非阻塞的数据传输方式，适用于需要高实时性的应用场景。通过本案例，您可以学习到：

1. ✅ **I2C中断模式配置**：如何设置I2C为中断模式
2. ✅ **中断回调函数**：如何处理I2C传输完成事件
3. ✅ **非阻塞传输**：如何使用中断模式进行非阻塞数据传输
4. ✅ **中断嵌套**：如何处理多个中断（EXTI和I2C）
5. ✅ **实际应用**：在中断回调中使用I2C中断模式读取数据

通过本案例，您可以快速掌握I2C中断模式的使用方法，并将其应用到您的项目中。

---

**最后更新**：2024-01-01
