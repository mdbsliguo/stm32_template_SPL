# Flash11 NOSPC错误诊断测试

## 概述

根据参考文档，NOSPC（-3904/-3905）错误99%是SPI驱动未等待操作完成导致，与内存配置无关。

本测试按照参考文档的顺序，逐步验证：
1. W25Q驱动是否正常
2. LittleFS最小系统是否正常
3. 缓冲区地址和对齐问题

## 测试顺序

### 测试1：W25Q直接驱动测试（在LittleFS之前）

**位置**：`main_example.c` - `test_w25q_direct()`

**测试内容**：
- 擦除扇区0
- 写入256字节测试数据（0x5A）
- 读取256字节数据
- 对比写入和读取的数据

**预期结果**：
- ✅ 如果数据完全一致：SPI驱动正常
- ❌ 如果数据不一致：SPI驱动有BUG，需要修复驱动

**关键检查点**：
- 擦除后是否等待完成（`W25Q_EraseSector`内部已实现）
- 写入后是否等待完成（`W25Q_Write`内部已实现）
- SPI时钟是否过快（建议36MHz）
- 供电是否稳定

### 测试2：LittleFS最小系统测试（在LittleFS初始化之后）

**位置**：`main_example.c` - `test_littlefs_minimal()`

**测试内容**：
1. 强制格式化（清除所有残留数据）
2. 挂载文件系统
3. 创建目录 `/testdir`（仅此一步）
4. 立即卸载确保落盘
5. 重新挂载验证

**预期结果**：
- ✅ 如果重新挂载成功：LittleFS最小系统正常
- ❌ 如果重新挂载失败：LittleFS配置或驱动有问题

### 测试3：缓冲区地址检查

**位置**：`main_example.c` - `test_buffer_addresses()`

**检查内容**：
- 缓冲区大小检查
- 缓冲区对齐要求（4字节对齐）
- 缓冲区地址重叠检查

**已修复**：
- ✅ `read_buffer`：已添加 `__attribute__((aligned(4)))`
- ✅ `prog_buffer`：已添加 `__attribute__((aligned(4)))`
- ✅ `lookahead_buffer`：已有 `__attribute__((aligned(4)))`

## LittleFS断言启用

**配置**：`config.h` - `LFS_NO_ASSERT = 0`

**自定义断言实现**：`main_example.c` - 在包含`littlefs.h`之前定义

**作用**：
- 当LittleFS内部断言失败时，会输出详细的错误信息
- 包括文件名、行号和断言条件
- 断言失败的位置就是问题根源

**输出格式**：
```
[ERROR][LFS_ASSERT] 断言失败: lfs.c:3458 - lfs->cfg->prog_size != 0
```

## 使用方法

1. **编译并烧录**程序
2. **观察串口输出**，按顺序执行三个测试
3. **如果测试1失败**：
   - 检查W25Q驱动代码
   - 确认等待机制是否正确
   - 检查SPI时钟频率
   - 检查供电稳定性
4. **如果测试2失败**：
   - 检查LittleFS配置参数
   - 查看断言输出，定位问题位置
5. **如果所有测试通过但仍有NOSPC错误**：
   - 检查缓冲区地址是否重叠
   - 检查是否有其他任务干扰
   - 检查文件系统碎片化问题

## 参考文档要点

1. **SPI驱动必须等待操作完成**：
   - 擦除后必须等待50-100ms
   - 写入后必须等待3-5ms
   - 检查Busy标志位

2. **缓冲区必须4字节对齐**：
   - 避免DMA/SPI数据错误
   - 已修复：所有缓冲区都已对齐

3. **启用断言定位问题**：
   - assert失败的位置就是问题根源
   - 已启用：自定义断言实现

## 注意事项

- 测试1在LittleFS初始化之前执行，确保先验证底层驱动
- 测试2会格式化文件系统，清除所有数据
- 断言启用后可能会在断言失败时卡死，这是正常的（用于调试）
- 如果问题仍然存在，建议检查硬件连接和供电稳定性

