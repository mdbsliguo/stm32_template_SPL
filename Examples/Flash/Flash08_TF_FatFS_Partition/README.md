# Flash08 - TF卡集成FatFS文件系统示例（两个分区）

## 📌 案例目的

- **核心目标**：演示FatFS文件系统的分区方案，创建MBR分区表，分区1（10%）给MCU直接访问，分区2（90%）给FAT32文件系统

### 核心功能

1. **分区方案格式化**：创建两个分区，分区1（10%）给MCU直接访问，分区2（90%）给FAT32文件系统
2. **文件系统操作**：挂载、卸载、格式化、获取文件系统信息
3. **MCU直接访问**：演示预留区域的直接扇区访问（访问分区1）
4. **文件操作**：创建、读取、写入、删除、重命名文件
5. **目录操作**：创建目录、遍历目录、删除目录
6. **综合应用场景**：数据日志记录、配置文件存储

### 学习重点

- 理解FatFS文件系统的分区方案实现
- 掌握MBR分区表的创建方法
- 学习文件系统与MCU直接访问的混合使用
- 了解分区方案的优势和使用场景

### 应用场景

适用于需要文件系统存储且需要MCU直接访问部分扇区的应用，如固件存储、配置数据、参数保存等场景。

**⚠️ 重要说明**：
- 本示例使用FatFS封装层（`fatfs_wrapper.h`），提供统一的错误码和接口
- 使用分区方案，创建MBR分区表
- 需要修改`ffconf.h`启用`FF_MULTI_PARTITION`和`FF_USE_MKFS`
- 逻辑：尝试挂载`"0:2:"`（分区2），如果失败（无文件系统）则创建分区表并格式化分区2
- 文件操作使用相对路径（已挂载到`"0:2:"`）

## 🔧 硬件要求

### 必需外设

- **LED1**：连接到 `PA1`（系统状态指示）

### 传感器/模块

#### TF卡（MicroSD卡）模块

| 引脚 | STM32连接 | 说明 |
|------|-----------|------|
| CS | PA11 | 片选信号（软件NSS模式） |
| SCK | PB13 | SPI2时钟信号 |
| MISO | PB14 | SPI2主入从出（数据接收） |
| MOSI | PB15 | SPI2主出从入（数据发送） |
| VCC | 3.3V | **⚠️ 重要：必须使用3.3V，不能使用5V！** |
| GND | GND | 电源地 |

**⚠️ 重要提示**：
- TF卡使用3.3V供电，使用5V会损坏卡
- CS引脚使用软件NSS模式，由软件控制拉低/拉高
- 确保电源稳定，避免写入过程中断电

#### OLED显示屏（软件I2C接口）

| 引脚 | STM32连接 | 说明 |
|------|-----------|------|
| SCL | PB8 | 软件I2C时钟线 |
| SDA | PB9 | 软件I2C数据线 |
| VCC | 3.3V | 电源 |
| GND | GND | 电源地 |

#### UART1（用于详细日志输出）

| 引脚 | STM32连接 | 说明 |
|------|-----------|------|
| TX | PA9 | UART1发送 |
| RX | PA10 | UART1接收 |
| 波特率 | 115200 | 串口通信波特率 |

## 📦 模块依赖

### 模块列表

| 模块分类 | 模块名称 | 用途 | 依赖关系 |
|---------|---------|------|---------|
| 中间件层 | FatFS | 文件系统（封装层） | diskio_spi |
| 中间件层 | diskio_spi | SPI磁盘I/O接口 | TF_SPI |
| 驱动层 | TF_SPI | TF卡SPI驱动 | SPI |
| 驱动层 | SPI | SPI硬件驱动 | GPIO |
| 驱动层 | OLED | OLED显示驱动 | I2C_SW |
| 驱动层 | I2C_SW | 软件I2C驱动 | GPIO |
| 驱动层 | LED | LED驱动 | GPIO |
| 驱动层 | UART | UART驱动 | GPIO |
| 系统服务层 | System_Init | 系统初始化 | GPIO, LED |
| 系统服务层 | Delay | 延时服务 | TIM2_TimeBase |
| 调试工具层 | Debug | printf重定向 | UART |
| 调试工具层 | Log | 分级日志系统 | Debug |
| 调试工具层 | ErrorHandler | 错误处理框架 | - |

## 🔄 实现流程

### 整体逻辑

程序执行流程分为以下几个阶段：

1. **系统初始化阶段**：初始化系统、SPI、TF_SPI、OLED、UART、Debug、Log等模块
2. **文件系统初始化阶段**：尝试挂载`"0:2:"`（分区2），如果失败（无文件系统）则创建分区表并格式化分区2，然后挂载文件系统
3. **MCU直接访问演示阶段**：演示MCU直接访问分区1（预留区域）
4. **文件操作演示阶段**：演示文件的创建、读写、删除、重命名等操作
5. **目录操作演示阶段**：演示目录的创建、遍历、删除等操作
6. **综合应用场景阶段**：演示数据日志记录和配置文件存储
7. **主循环阶段**：LED闪烁指示系统运行

### 关键方法

1. **分区方案格式化**
   - 方法：使用`f_fdisk()`创建分区表，然后使用`f_mkfs()`在分区2上创建文件系统
   - 分区1：10%容量，用于MCU直接访问
   - 分区2：90%容量，用于FAT32文件系统
   - 需要启用`FF_MULTI_PARTITION`和`FF_USE_MKFS`

2. **文件系统初始化**
   - 方法：先尝试挂载`"0:2:"`（分区2），如果失败则创建分区表并格式化分区2，然后重新挂载
   - 使用场景：首次使用SD卡或SD卡未格式化时
   - 注意事项：格式化会清空SD卡所有数据，需要提示用户

3. **MCU直接访问**
   - 方法：使用TF_SPI模块直接访问分区1的扇区
   - 使用场景：需要存储固件、配置数据等，不通过文件系统
   - 注意事项：确保分区1与分区2隔离，避免数据冲突

4. **文件操作**
   - 方法：使用FatFS封装层API进行文件操作
   - 使用场景：读写文件、追加数据、文件管理
   - 注意事项：使用相对路径（已挂载到`"0:2:"`），写入后调用`FatFS_FileSync()`确保数据写入磁盘

## 📚 关键函数说明

### 文件系统操作相关函数

- **`FatFS_Mount()`**：挂载文件系统
  - 在本案例中用于挂载分区2（`"0:2:"`）
  - 如果文件系统不存在，返回`FATFS_ERROR_NO_FILESYSTEM`错误
  - 挂载成功后可以开始文件操作

- **`f_fdisk()`**：创建分区表
  - 在本案例中用于创建MBR分区表
  - 分区1：10%容量（MCU直接访问）
  - 分区2：90%容量（FAT32文件系统）

- **`f_mkfs()`**：格式化文件系统
  - 在本案例中用于在分区2上创建FAT32文件系统
  - 使用`"0:2:"`指定分区2

- **`FatFS_GetFreeSpace()`**：获取空闲空间
  - 在本案例中用于显示文件系统信息
  - 返回空闲簇数和总簇数
  - 可以计算空闲空间大小

### MCU直接访问相关函数

- **`TF_SPI_ReadBlock()`**：读取扇区
  - 在本案例中用于读取分区1的扇区
  - 直接访问，不通过文件系统

- **`TF_SPI_WriteBlock()`**：写入扇区
  - 在本案例中用于写入分区1的扇区
  - 直接访问，不通过文件系统

### 文件操作相关函数

- **`FatFS_FileOpen()`**：打开文件
- **`FatFS_FileWrite()`**：写入文件
- **`FatFS_FileRead()`**：读取文件
- **`FatFS_FileSeek()`**：定位文件指针
- **`FatFS_FileSync()`**：同步文件
- **`FatFS_FileDelete()`**：删除文件
- **`FatFS_FileRename()`**：重命名文件

### 目录操作相关函数

- **`FatFS_DirCreate()`**：创建目录
- **`FatFS_DirOpen()`**：打开目录
- **`FatFS_DirRead()`**：读取目录项
- **`FatFS_DirClose()`**：关闭目录
- **`FatFS_DirDelete()`**：删除目录

**详细函数实现和调用示例请参考**：`main_example.c` 中的代码

## ⚠️ 注意事项与重点

### ⚠️ 重要提示

1. **FatFS配置修改**
   - 需要修改`Middlewares/storage/fatfs/ffconf.h`：
     - `#define FF_MULTI_PARTITION  1`（启用多分区支持）
     - `#define FF_USE_MKFS         1`（启用格式化功能）

2. **VolToPart配置**
   - 需要配置`VolToPart[]`数组，将逻辑驱动器映射到物理驱动器和分区
   - 在本案例中，逻辑驱动器0映射到物理驱动器0，分区2
   - 配置在`fatfs_wrapper.c`中

3. **格式化警告**
   - 格式化会清空SD卡所有数据，需要提示用户
   - 建议在格式化前备份重要数据
   - 格式化过程可能需要较长时间（取决于SD卡容量）

4. **文件路径格式**
   - 挂载路径：`"0:2:"`（分区2）
   - 文件操作：使用相对路径（如`"test.txt"`），因为已挂载到`"0:2:"`

5. **MCU直接访问注意事项**
   - 分区1与分区2必须隔离，避免数据冲突
   - 使用TF_SPI模块直接访问分区1，不通过文件系统
   - **⚠️ 重要：分区表保护**
     - MBR分区表位于扇区0，包含分区信息，**绝对不能覆盖或损坏**
     - MCU直接访问分区1时，应从扇区1开始（或从分区表后的扇区开始），避免覆盖扇区0
     - 如果分区表损坏，整个SD卡的分区信息将丢失，需要重新创建分区表
     - 建议在代码中添加分区表保护检查，确保不会意外覆盖扇区0
   - 确保访问的扇区在分区1范围内（从扇区1开始，到分区1结束）

6. **分区大小计算**
   - 分区1：总容量的10%（固定比例）
   - 分区2：总容量的90%（固定比例）
   - 根据SD卡总容量自动计算

### 🔑 关键点

1. **分区表保护（最重要）**
   - MBR分区表位于扇区0，包含所有分区信息
   - **绝对禁止**通过MCU直接访问覆盖或修改扇区0
   - MCU直接访问分区1时，必须从扇区1开始（跳过扇区0）
   - 建议在代码中添加扇区地址检查，确保不会访问扇区0
   - 如果分区表损坏，需要重新创建分区表并格式化，所有数据将丢失

2. **文件同步**
   - 写入文件后必须调用`FatFS_FileSync()`确保数据写入磁盘
   - 频繁同步会影响性能，根据需要决定同步频率
   - 关闭文件前建议同步，确保数据不丢失

3. **错误处理**
   - 所有FatFS操作都要检查返回值
   - 使用`ErrorHandler_Handle()`处理错误
   - 根据错误码判断错误类型，采取相应措施

4. **内存管理**
   - 文件读写缓冲区要足够大
   - 目录遍历需要足够的栈空间

## 🔍 常见问题排查

### 1. 文件系统挂载失败

**可能原因**：
- SD卡未插入或损坏
- 分区2未格式化
- SPI通信失败
- TF_SPI初始化失败
- 未启用FF_MULTI_PARTITION

**解决方法**：
1. 检查SD卡是否正确插入
2. 检查SPI和TF_SPI初始化是否成功
3. 检查硬件连接（CS、SCK、MISO、MOSI）
4. 检查`ffconf.h`配置（FF_MULTI_PARTITION、FF_USE_MKFS）
5. 检查VolToPart配置
6. 查看串口日志，确认具体错误信息

### 2. 分区表创建失败

**可能原因**：
- SD卡写保护
- SD卡损坏
- 未启用FF_MULTI_PARTITION
- 未启用FF_USE_MKFS

**解决方法**：
1. 检查SD卡写保护开关
2. 检查SD卡是否损坏
3. 检查`ffconf.h`配置（FF_MULTI_PARTITION、FF_USE_MKFS）
4. 查看串口日志，确认具体错误信息

### 3. MCU直接访问失败

**可能原因**：
- 分区1未初始化
- 扇区地址超出分区1范围
- TF_SPI模块未初始化

**解决方法**：
1. 检查分区表是否创建成功
2. 检查分区1信息是否正确
3. 检查扇区地址是否在分区1范围内
4. 检查TF_SPI模块是否已初始化
5. 查看串口日志，确认具体错误信息

## 💡 扩展练习

### 循序渐进部分

1. **修改分区大小比例**
   - 尝试修改分区1和分区2的大小比例
   - 观察不同比例对文件系统的影响
   - 理解分区大小选择的考虑因素

2. **实现分区信息查询**
   - 实现查询分区表信息的功能
   - 显示每个分区的起始扇区、大小等信息
   - 验证分区信息是否正确

### 实际场景坑点部分

3. **处理分区表损坏的情况**
   - 检测分区表是否损坏
   - 实现分区表修复功能
   - 处理异常断电后的恢复

4. **优化MCU直接访问性能**
   - 使用多扇区读写优化性能
   - 实现扇区缓存机制
   - 处理并发访问的情况

## 📖 相关文档

### 模块文档

- **FatFS模块**：`Middlewares/storage/fatfs/README.md`
- **TF_SPI模块**：`Drivers/flash/tf_spi.h`
- **SPI模块**：`Drivers/spi/spi_hw.h`
- **OLED模块**：`Drivers/display/oled_ssd1306.h`
- **UART模块**：`Drivers/uart/uart.h`

### 业务文档

- **主程序代码**：`main_example.c`
- **硬件配置**：`board.h`
- **模块配置**：`config.h`
- **项目规范**：`PROJECT_KEYWORDS.md`

## 📝 更新日志

### v1.0.0 (2024-01-01)
- 初始版本
- 实现分区方案格式化（创建MBR分区表，分区1：10%，分区2：90%）
- 实现MCU直接访问演示（访问分区1）
- 实现文件操作演示（创建、读写、删除、重命名）
- 实现目录操作演示（创建、遍历、删除）
- 实现综合应用场景（数据日志、配置文件）

