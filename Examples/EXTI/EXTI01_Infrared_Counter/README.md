# EXTI01 - 对射式红外传感器计次示例

使用外部中断（EXTI）实现对射式红外传感器的计次功能。

---

## 📋 案例目的

- **核心目标**：演示如何使用外部中断（EXTI）实现对射式红外传感器的计次功能
- **学习重点**：
  - EXTI外部中断的配置和使用方法
  - EXTI中断回调函数的编写
  - 中断中只做简单操作（计数），复杂操作在主循环处理
  - 理解中断服务程序（ISR）已在Core层实现，案例只需写回调函数
- **应用场景**：适用于需要快速响应外部事件的场景，如物体计数、触发检测等

---

## 🔧 硬件要求

### 必需外设

- **LED1**：`PA1`（状态指示，计数时闪烁）

### 传感器/模块

- **对射式红外传感器模块**
  - OUT：`PA0`（EXTI Line 0，外部中断输入）
  - VCC：3.3V或5V（根据传感器规格）
  - GND：GND
  - **注意**：
    - 对射式红外传感器输出逻辑可能不同，本案例使用**双边沿触发**（`EXTI_TRIGGER_RISING_FALLING`）
    - 双边沿触发可以在电平变化时（上升沿或下降沿）都触发中断，适用于各种传感器输出逻辑
    - 如果传感器输出逻辑已知，也可以使用单边沿触发（上升沿或下降沿）

- **OLED显示屏**（SSD1306，软件I2C接口，可选）
  - SCL：`PB8`
  - SDA：`PB9`
  - VCC：3.3V
  - GND：GND

### 硬件连接

| STM32F103C8T6 | 对射式红外传感器 | 说明 |
|--------------|----------------|------|
| PA0 | OUT（输出信号） | EXTI Line 0，双边沿触发 |
| 3.3V | VCC | 电源（根据传感器规格，可能是3.3V或5V） |
| GND | GND | 地线 |

**⚠️ 重要提示**：
- PA0配置为**上拉输入**（`GPIO_MODE_INPUT_PULLUP`），适用于开漏输出的传感器
- 如果传感器内部已有上拉，可以改为浮空输入（`GPIO_MODE_INPUT_FLOATING`）

**⚠️ 重要提示**：
- 案例是独立工程，硬件配置在案例目录下的 `board.h` 中
- 如果硬件引脚不同，直接修改 `Examples/EXTI/EXTI01_Infrared_Counter/board.h` 中的配置即可
- 本案例使用**双边沿触发**，适用于各种传感器输出逻辑（遮挡时高电平或低电平都能触发）
- 如果传感器输出逻辑已知，可以改为单边沿触发以提高效率

---

## 📦 模块依赖

- `exti`：外部中断模块（核心功能）
- `gpio`：GPIO模块（EXTI依赖）
- `led`：LED驱动模块（状态指示）
- `oled`：OLED显示驱动模块（显示计数，可选）
- `soft_i2c`：软件I2C模块（OLED依赖）
- `delay`：延时模块
- `system_init`：系统初始化模块

---

## 🔄 实现流程

### 整体逻辑

1. **系统初始化阶段**：
   - 调用 `System_Init()` 初始化系统基础功能
   - 初始化OLED显示（可选）
   - 初始化EXTI0（PA0，双边沿触发，中断模式）
   - 重新配置PA0为上拉输入（EXTI初始化会将GPIO配置为浮空输入）
   - 设置EXTI中断回调函数
   - 使能EXTI中断

2. **主循环阶段**：
   - 检查计数器是否变化
   - 更新OLED显示（如果使用）
   - LED闪烁反馈
   - 延时降低CPU占用率

3. **中断处理阶段**（自动触发）：
   - 对射式红外传感器检测到物体通过
   - 触发EXTI0中断
   - Core层的 `EXTI0_IRQHandler()` 自动调用 `EXTI_IRQHandler(EXTI_LINE_0)`
   - EXTI模块调用用户回调函数 `InfraredSensor_Callback()`
   - 回调函数中只做简单操作：计数器递增

### 关键方法

1. **EXTI初始化**：使用 `EXTI_HW_Init()` 初始化EXTI线
   - 参数：EXTI线号、触发模式（上升沿/下降沿/双边沿）、模式（中断/事件）

2. **EXTI回调设置**：使用 `EXTI_SetCallback()` 设置中断回调函数
   - 回调函数在中断中调用，应尽可能简短
   - 只做简单操作（如计数、设置标志），复杂操作在主循环处理

3. **EXTI使能**：使用 `EXTI_Enable()` 使能EXTI中断
   - 使能后，EXTI中断才会触发

### 工作流程示意

```text
系统初始化
    ↓
EXTI0初始化（PA0，双边沿触发）
    ↓
设置EXTI回调函数
    ↓
使能EXTI中断
    ↓
主循环（显示计数）
    ↓
物体通过 → 传感器输出下降沿 → EXTI0中断触发
    ↓
Core层ISR（EXTI0_IRQHandler）→ EXTI模块处理（EXTI_IRQHandler）
    ↓
用户回调函数（InfraredSensor_Callback）→ 计数器递增
    ↓
主循环检测到计数变化 → 更新显示
```

---

## 📚 关键函数说明

### EXTI相关函数

- **`EXTI_HW_Init()`**：初始化外部中断
  - 参数：EXTI线号、触发模式、模式（中断/事件）
  - 返回值：`EXTI_OK`表示成功

- **`EXTI_SetCallback()`**：设置EXTI中断回调函数
  - 参数：EXTI线号、回调函数指针、用户数据指针
  - 回调函数在中断中调用，应尽可能简短

- **`EXTI_Enable()`**：使能EXTI中断
  - 使能后，EXTI中断才会触发

- **`EXTI_Disable()`**：禁用EXTI中断
  - 禁用后，EXTI中断不会触发

### 中断服务程序（ISR）

**⚠️ 重要说明**：
- EXTI的ISR已在 `Core/stm32f10x_it.c` 中实现
- 案例**不需要**实现ISR，只需要写回调函数
- ISR会自动调用EXTI模块的处理函数，然后调用用户回调函数

**ISR实现位置**：
- `Core/stm32f10x_it.c`：包含所有EXTI ISR实现
  - EXTI0-4：独立中断向量（`EXTI0_IRQHandler` ~ `EXTI4_IRQHandler`）
  - EXTI5-9：共享中断向量（`EXTI9_5_IRQHandler`）
  - EXTI10-15：共享中断向量（`EXTI15_10_IRQHandler`）

---

## 💻 代码说明

### 中断回调函数

```c
static void InfraredSensor_Callback(EXTI_Line_t line, void *user_data)
{
    (void)line;
    (void)user_data;
    
    /* 在中断回调中只做简单操作：计数 */
    g_counter++;
    
    /* 注意：不要在这里执行复杂操作（如OLED显示），复杂操作在主循环处理 */
}
```

**设计原则**：
- ✅ 只做简单操作：计数、设置标志等
- ❌ 不要执行复杂操作：OLED显示、延时、阻塞操作等
- ✅ 复杂操作在主循环处理

### 主循环逻辑

```c
while(1)
{
    /* 检查计数器是否变化 */
    if (g_counter != last_counter)
    {
        last_counter = g_counter;
        
        /* 更新OLED显示 */
        OLED_ShowNum(2, 7, g_counter, 5);
        
        /* LED闪烁反馈 */
        LED1_Toggle();
    }
    
    /* 延时降低CPU占用率 */
    Delay_ms(10);
}
```

---

## 🚀 使用方法

### 步骤1：硬件准备

- STM32F103C8T6开发板（或兼容板）
- 对射式红外传感器模块
- OLED显示屏（可选）
- USB数据线（用于下载程序）

### 步骤2：硬件连接

- 对射式红外传感器OUT → PA0
- 传感器VCC → 3.3V或5V
- 传感器GND → GND
- OLED SCL → PB8（可选）
- OLED SDA → PB9（可选）

### 步骤3：打开案例工程

- 双击 `Examples/EXTI/EXTI01_Infrared_Counter/Examples.uvprojx` 打开Keil工程

### 步骤4：检查/修改硬件配置

- 检查案例目录下的 `board.h` 配置是否正确
- 如果硬件引脚不同，直接修改 `board.h` 中的配置

### 步骤5：编译项目

- 点击工具栏的 **编译按钮**（或按 `F7`）
- 等待编译完成，应该显示：`0 Error(s), 0 Warning(s)`

### 步骤6：下载到开发板

- 点击工具栏的 **下载按钮**（或按 `F8`）
- 等待下载完成，程序会自动运行

### 步骤7：观察效果

- 当物体通过对射式红外传感器时，计数器会递增
- OLED显示计数（如果使用）
- LED闪烁反馈（每次计数时闪烁）

---

## ⚠️ 常见问题排查

### 问题1：计数器不递增

**可能原因**：
- EXTI初始化失败
- 传感器未正确连接
- GPIO配置问题（需要上拉输入）

**解决方法**：
1. 检查 `board.h` 中的EXTI配置是否正确（应使用 `EXTI_TRIGGER_RISING_FALLING`）
2. 检查PA0连接是否正确
3. 确认PA0配置为上拉输入（`GPIO_MODE_INPUT_PULLUP`）
4. 使用万用表测量PA0引脚电平，确认传感器输出有变化
5. 检查传感器电源和地线连接

### 问题2：EXTI初始化失败

**现象**：LED快速闪烁（100ms间隔）

**可能原因**：
- GPIO配置错误
- EXTI配置错误

**解决方法**：
1. 检查 `board.h` 中的EXTI配置
2. 检查GPIO是否已正确初始化
3. 查看错误处理日志（如果启用）

### 问题3：计数不准确（重复计数或漏计数）

**可能原因**：
- 传感器输出抖动
- 物体通过速度过快

**解决方法**：
1. 检查传感器输出是否稳定
2. 本案例已使用双边沿触发，可以检测所有电平变化
3. 如果传感器输出有抖动，可以在回调函数中添加软件消抖（不推荐，会增加中断处理时间）
4. 检查传感器安装位置和角度，确保物体通过时信号稳定

---

## 📝 扩展练习

1. **修改触发模式**：
   - 如果传感器输出逻辑已知，可以改为单边沿触发（`EXTI_TRIGGER_RISING` 或 `EXTI_TRIGGER_FALLING`）
   - 当前使用双边沿触发（`EXTI_TRIGGER_RISING_FALLING`），适用于各种传感器输出逻辑

2. **使用其他EXTI线**：
   - 尝试使用PA1（EXTI Line 1）
   - 尝试使用PB0（EXTI Line 0，但不同端口）

3. **添加消抖功能**：
   - 在主循环中添加软件消抖逻辑
   - 使用定时器实现硬件消抖

4. **多传感器计数**：
   - 使用多个EXTI线连接多个传感器
   - 实现多通道计数

---

## 📖 相关文档

- **EXTI模块文档**：`Drivers/peripheral/exti/README.md`
- **案例参考**：`Examples/README.md`
- **项目规范**：`PROJECT_KEYWORDS.md`

---

## ⚠️ 重要说明

1. **ISR已在Core层实现**：
   - EXTI的ISR已在 `Core/stm32f10x_it.c` 中实现
   - 案例**不需要**实现ISR，只需要写回调函数

2. **中断回调函数应简短**：
   - 在中断回调中只做简单操作（计数、设置标志）
   - 不要执行复杂操作（OLED显示、延时等）

3. **性能开销**：
   - EXTI0使用独立中断向量，开销很小（约0.14-0.28微秒）
   - 对于对射式红外传感器（低频中断），开销完全可以忽略

4. **硬件配置**：
   - 案例是独立工程，硬件配置在案例目录下的 `board.h` 中
   - 如果硬件引脚不同，直接修改 `board.h` 中的配置即可

---

---

## ✅ 测试状态

**测试日期**：2024-01-01  
**测试结果**：✅ 测试通过，功能正常

**测试内容**：
- ✅ EXTI初始化正常
- ✅ 中断触发正常（遮挡和离开都能触发）
- ✅ 计数器递增正常（遮挡+1，离开+1）
- ✅ OLED显示正常
- ✅ LED反馈正常

**注意事项**：
- PA0配置为上拉输入，适用于开漏输出的传感器
- 使用双边沿触发，适用于各种传感器输出逻辑
- 中断回调函数只做计数操作，符合设计原则

---

**最后更新**：2024-01-01

