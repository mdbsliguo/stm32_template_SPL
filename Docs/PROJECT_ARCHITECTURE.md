# STM32工程模板项目架构框图

**版本**：1.0.0  
**更新日期**：2024-01-01  
**目标芯片**：STM32F103C8T6

---

## 📐 项目整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        应用层 (Application Layer)                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Examples/          - 演示案例（LED、OLED、I2C、RTC等）  │  │
│  │  Core/main.c        - 主程序入口                        │  │
│  │  Core/stm32f10x_it.c - 中断服务函数                      │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      系统服务层 (System Layer)                   │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  System/system_init.c    - 系统初始化（自动初始化各模块）│  │
│  │  System/delay.c          - 延时服务                      │  │
│  │  System/clock_manager.c  - 时钟管理                      │  │
│  │  Drivers/timer/TIM2_TimeBase.c - TIM2时间基准（系统心跳）│  │
│  │  System/iwdg.c           - 独立看门狗                    │  │
│  │  System/module_controller.c - 模块控制器                 │  │
│  │  System/system_monitor.c - 系统监控                      │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      驱动层 (Driver Layer)                       │
│  ┌──────────────┬──────────────┬──────────────┬──────────────┐ │
│  │  basic/      │  i2c/        │  spi/        │  uart/       │ │
│  │  - gpio      │  - i2c_hw    │  - spi_hw    │  - uart      │ │
│  │  - led       │  - i2c_sw    │  - spi_sw    │              │ │
│  ├──────────────┼──────────────┼──────────────┼──────────────┤ │
│  │  display/    │  sensors/    │  timer/      │  analog/     │ │
│  │  - oled      │  - ds3231    │  - pwm       │  - adc       │ │
│  │              │              │  - encoder  │  - dac       │ │
│  │              │              │  - ic       │              │ │
│  │              │              │  - oc       │              │ │
│  ├──────────────┼──────────────┼──────────────┼──────────────┤ │
│  │  peripheral/ │  can/        │  dma/        │  usb/        │ │
│  │  - exti      │  - can       │  - dma       │  - usb       │ │
│  │  - nvic      │              │              │              │ │
│  │  - rtc       │              │              │              │ │
│  │  - wwdg      │              │              │              │ │
│  │  - bkp       │              │              │              │ │
│  │  - pwr       │              │              │              │ │
│  │  - flash     │              │              │              │ │
│  │  - crc       │              │              │              │ │
│  │  - dbgmcu    │              │              │              │ │
│  │  - sdio      │              │              │              │ │
│  │  - fsmc      │              │              │              │ │
│  │  - cec       │              │              │              │ │
│  └──────────────┴──────────────┴──────────────┴──────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      硬件抽象层 (BSP Layer)                      │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  BSP/board.h  - 硬件配置表（引脚、外设映射）              │  │
│  │                - 配置驱动，非硬编码                       │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      标准外设库 (SPL Library)                     │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Library/     - STM32F10x标准外设库（SPL）               │  │
│  │  Start/       - 启动文件、系统初始化                      │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      硬件层 (Hardware)                            │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  STM32F103C8T6 微控制器                                   │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔄 数据流向图

```
┌─────────────┐
│  应用层     │
│  (Examples) │
└──────┬──────┘
       │ 调用API
       ↓
┌──────────────────────────────────────────────────────────────┐
│  系统服务层                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ system_init  │→ │ delay        │→ │ clock_manager│     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└──────────────────────────────────────────────────────────────┘
       │ 调用驱动API
       ↓
┌──────────────────────────────────────────────────────────────┐
│  驱动层                                                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ GPIO/LED     │  │ I2C/SPI/UART │  │ Timer/ADC    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└──────────────────────────────────────────────────────────────┘
       │ 读取配置
       ↓
┌──────────────────────────────────────────────────────────────┐
│  硬件抽象层 (BSP)                                             │
│  ┌──────────────┐                                            │
│  │ board.h      │  - 配置表（CONFIG宏）                      │
│  │              │  - 引脚映射                                │
│  │              │  - 外设实例映射                             │
│  └──────────────┘                                            │
└──────────────────────────────────────────────────────────────┘
       │ 调用SPL库
       ↓
┌──────────────────────────────────────────────────────────────┐
│  标准外设库 (SPL)                                            │
│  ┌──────────────┐                                            │
│  │ STM32F10x    │  - 寄存器操作                              │
│  │ SPL Library  │  - 硬件抽象                                │
│  └──────────────┘                                            │
└──────────────────────────────────────────────────────────────┘
       │ 寄存器访问
       ↓
┌──────────────────────────────────────────────────────────────┐
│  硬件 (STM32F103C8T6)                                        │
└──────────────────────────────────────────────────────────────┘
```

---

## 🏗️ 模块依赖关系

```
┌─────────────────────────────────────────────────────────────┐
│                    核心依赖关系                               │
└─────────────────────────────────────────────────────────────┘

所有驱动模块
    ↓
┌──────────────┐
│  BSP/board.h │  ← 硬件配置（所有模块依赖）
└──────────────┘
    ↓
┌──────────────┐
│  GPIO        │  ← 基础模块（大部分模块依赖）
└──────────────┘
    ↓
┌──────────────┐
│  Delay       │  ← 延时服务（超时、延时）
└──────────────┘
    ↓
┌──────────────┐
│  NVIC        │  ← 中断管理（中断模式模块依赖）
└──────────────┘
    ↓
┌──────────────┐
│  EXTI        │  ← 外部中断（按键、传感器等）
└──────────────┘
    ↓
┌──────────────┐
│  DMA         │  ← DMA传输（UART、SPI、ADC等）
└──────────────┘
```

---

## 📦 模块分类架构

```
┌─────────────────────────────────────────────────────────────┐
│  基础模块 (basic/)                                            │
│  ├── GPIO    - 通用输入输出                                  │
│  └── LED     - LED驱动                                        │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  通信接口模块                                                │
│  ├── I2C     - I2C硬件/软件驱动                              │
│  ├── SPI     - SPI硬件/软件驱动                              │
│  ├── UART    - 串口通信                                      │
│  ├── CAN     - CAN总线                                        │
│  └── USB     - USB设备框架                                   │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  显示与传感器模块                                             │
│  ├── Display - OLED SSD1306显示驱动                          │
│  └── Sensors - DS3231实时时钟                                │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  定时器功能模块 (timer/)                                      │
│  ├── PWM            - PWM输出                                │
│  ├── Input Capture  - 输入捕获（频率、占空比测量）          │
│  ├── Encoder        - 编码器模式                             │
│  └── Output Compare - 输出比较                               │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  模拟外设模块 (analog/)                                       │
│  ├── ADC - 模数转换器                                        │
│  └── DAC - 数模转换器                                        │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  系统外设模块 (peripheral/)                                   │
│  ├── EXTI    - 外部中断                                      │
│  ├── NVIC    - 中断控制器                                    │
│  ├── RTC     - 实时时钟                                      │
│  ├── WWDG    - 窗口看门狗                                    │
│  ├── BKP     - 备份寄存器                                    │
│  ├── PWR     - 电源管理                                      │
│  ├── Flash   - Flash编程/擦除                                │
│  ├── CRC     - CRC32计算                                     │
│  ├── DBGMCU  - 调试模式配置                                  │
│  ├── SDIO    - SD卡接口                                      │
│  ├── FSMC    - 外部存储器接口                                │
│  └── CEC     - 消费电子控制协议                              │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  传输模块                                                    │
│  └── DMA - 直接内存访问                                      │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔧 系统初始化流程

```
main()
  │
  ├─→ System_Init()
  │     │
  │     ├─→ System_InitClock()      - 时钟初始化
  │     │
  │     ├─→ GPIO_Init()             - GPIO初始化（通过board.h配置）
  │     │
  │     ├─→ LED_Init()              - LED初始化（通过board.h配置）
  │     │
  │     ├─→ Delay_Init()            - 延时模块初始化
  │     │
  │     ├─→ TIM2_TimeBase_Init()    - TIM2时间基准初始化（系统心跳）
  │     │
  │     ├─→ ClockManager_Init()     - 时钟管理初始化
  │     │
  │     ├─→ ModuleController_Init() - 模块控制器初始化
  │     │
  │     └─→ SystemMonitor_Init()    - 系统监控初始化（可选）
  │
  └─→ while(1) { /* 主循环 */ }
```

---

## 🛡️ 错误处理架构

```
┌─────────────────────────────────────────────────────────────┐
│  错误处理流程                                                │
└─────────────────────────────────────────────────────────────┘

驱动模块函数
    │
    ├─→ 参数校验失败
    │       │
    │       └─→ ErrorHandler_Report()  - 报告错误
    │             │
    │             ├─→ 错误码定义 (Common/error_code.h)
    │             │
    │             ├─→ 错误统计 (可选，CONFIG_ERROR_HANDLER_STATS_EN)
    │             │
    │             └─→ 错误回调 (可选)
    │
    ├─→ 硬件操作失败
    │       │
    │       └─→ ErrorHandler_Report()  - 报告错误
    │
    └─→ 超时
            │
            └─→ ErrorHandler_Report()  - 报告错误
```

---

## 📋 配置系统架构

```
┌─────────────────────────────────────────────────────────────┐
│  配置系统                                                    │
└─────────────────────────────────────────────────────────────┘

System/config.h
    │
    ├─→ 模块开关 (CONFIG_MODULE_XXX_ENABLED)
    │     │
    │     └─→ 控制模块编译 (#if CONFIG_MODULE_XXX_ENABLED)
    │
    ├─→ 功能开关 (CONFIG_XXX_YYY_EN)
    │     │
    │     └─→ 控制功能编译 (#ifdef CONFIG_XXX_YYY_EN)
    │
    └─→ 参数配置 (CONFIG_XXX_VALUE)
          │
          └─→ 运行时参数（超时、阈值等）

BSP/board.h
    │
    ├─→ 硬件配置表 (XXX_CONFIGS)
    │     │
    │     ├─→ LED_CONFIGS      - LED配置
    │     ├─→ I2C_CONFIGS      - I2C配置
    │     ├─→ SPI_CONFIGS      - SPI配置
    │     ├─→ UART_CONFIGS    - UART配置
    │     ├─→ PWM_CONFIGS      - PWM配置
    │     └─→ ...              - 其他外设配置
    │
    └─→ 引脚映射
          │
          └─→ 外设到GPIO的映射关系
```

---

## 🔌 中断处理架构

```
┌─────────────────────────────────────────────────────────────┐
│  中断处理流程                                                │
└─────────────────────────────────────────────────────────────┘

硬件中断触发
    │
    ├─→ Core/stm32f10x_it.c (中断向量表)
    │     │
    │     ├─→ EXTI0_IRQHandler()      - 外部中断0
    │     ├─→ EXTI1_IRQHandler()      - 外部中断1
    │     ├─→ TIM2_IRQHandler()       - 定时器2中断
    │     ├─→ USART1_IRQHandler()    - UART1中断
    │     ├─→ I2C1_EV_IRQHandler()   - I2C1事件中断
    │     └─→ ...                     - 其他中断
    │           │
    │           └─→ 调用驱动层中断处理函数
    │                 │
    │                 └─→ 调用用户注册的回调函数
    │
    └─→ 驱动层中断处理
          │
          ├─→ 清除中断标志
          │
          ├─→ 处理中断事件
          │
          └─→ 调用回调函数（如果注册）
```

---

## 📊 模块状态管理

```
┌─────────────────────────────────────────────────────────────┐
│  模块生命周期                                                │
└─────────────────────────────────────────────────────────────┘

模块初始化
    │
    ├─→ Module_Init()
    │     │
    │     ├─→ 参数校验
    │     │
    │     ├─→ 硬件初始化（GPIO、时钟、外设）
    │     │
    │     ├─→ 状态标记 (g_xxx_initialized = true)
    │     │
    │     └─→ 返回状态码
    │
    ├─→ 运行时操作
    │     │
    │     ├─→ 检查初始化状态
    │     │
    │     ├─→ 执行操作
    │     │
    │     └─→ 返回结果
    │
    └─→ Module_Deinit()
          │
          ├─→ 禁用外设
          │
          ├─→ 释放资源
          │
          └─→ 清除状态标记 (g_xxx_initialized = false)
```

---

## 🎯 设计原则

1. **分层隔离**：上层不直接访问底层硬件
2. **配置驱动**：通过配置表而非硬编码
3. **统一错误处理**：错误码系统与异常处理
4. **可测试性**：模块独立、接口清晰
5. **可移植性**：硬件抽象、跨平台适配
6. **防御性编程**：参数校验、边界检查、空指针保护

---

## 📝 说明

- **箭头方向**：表示调用关系或数据流向
- **分层结构**：从上到下，应用层 → 系统层 → 驱动层 → BSP层 → SPL库 → 硬件
- **模块依赖**：下层模块为上层模块提供服务
- **配置驱动**：所有硬件配置通过 `BSP/board.h` 统一管理
- **模块开关**：通过 `System/config.h` 控制模块编译

---

**最后更新**：2024-01-01

