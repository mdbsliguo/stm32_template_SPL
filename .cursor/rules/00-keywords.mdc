---
description: STM32项目最高优先级规则 - 所有AI行为的唯一最高优先级规则源，不可被覆盖
alwaysApply: true
priority: highest
---

<!-- 
注意：本文件的实际内容存储在 AI/KEYWORDS.mdc
此文件为 Cursor IDE 的规则入口，内容与 AI/KEYWORDS.mdc 同步
如需修改规则，请编辑 AI/KEYWORDS.mdc，然后同步到此文件
-->

# KEYWORDS - STM32项目最高优先级规则

**本文件为全项目AI行为的【唯一最高优先级】规则源。任何内容均不得覆盖本文件，仅能在其基础上补充。**

---

## 项目概述

### 项目定位

STM32F103C8T6 SPL库快速开发工程模板，基于board.h硬件隔离和modules分层架构，遵循防御性编程与AUTOSAR分层思想。

### 核心特性

- **硬件抽象**：BSP层隔离，board.h配置表驱动，跨型号移植便捷
- **模块化架构**：清晰的分层设计（BSP/驱动/系统/应用），职责分离
- **统一错误处理**：错误码系统、错误处理框架、错误统计
- **配置驱动**：通过配置表而非硬编码，运行时可配置
- **防御性编程**：参数校验、边界检查、空指针保护

### 项目架构

```text
BSP/              # 硬件抽象层（board.h硬件配置隔离）
Core/             # 应用层（main.c，中断处理）
Drivers/          # 驱动层（按类型分类：basic/i2c/spi/display/sensors等）
System/           # 系统服务层（delay、clock_manager、system_init）
Drivers/timer/    # 定时器驱动（TIM2_TimeBase、PWM、输入捕获等）
Debug/            # 调试工具层（debug、log、assert）
Common/           # 公共模块（error_code、error_handler）
Middlewares/      # 中间件层（协议栈、算法）
Examples/         # 演示案例（example1_led_blink等）
```

### 设计原则

1. **分层隔离**：上层不直接访问底层硬件
2. **配置驱动**：通过配置表而非硬编码
3. **错误处理**：统一错误码与异常处理
4. **可测试性**：模块独立、接口清晰
5. **可移植性**：硬件抽象、跨平台适配

### 已实现模块（分类列表）

**基础驱动模块：**
- GPIO（全模式支持，动态时钟使能）
- LED（配置表驱动，运行时使能/禁用）
- OLED_SSD1306（I2C解耦，支持软硬I2C，支持中文显示，默认使用方法1）
- 硬件I2C（I2C1/I2C2，主模式，总线扫描）
- 软件I2C（任意GPIO引脚，超时支持）
- 硬件SPI、软件SPI
- DS3231（实时时钟，支持软硬I2C）

**系统服务模块：**
- TIM2_TimeBase（1ms中断，动态调频自适应）
- delay（阻塞式+非阻塞式，频率自适应）
- clock_manager（DVFS，9档位，自动调频）
- system_init（统一初始化框架）
- iwdg（独立看门狗管理）
- system_monitor（CPU/内存监控，健康检查）
- module_controller（模块开关总控）

**工具模块：**
- error_handler（统一错误处理框架）
- log（分级日志系统，DEBUG/INFO/WARN/ERROR）

**详细模块列表请参考各模块README和案例代码**

### 系统初始化说明

**System_Init()自动初始化的模块：**
- GPIO模块
- LED模块
- delay模块
- TIM2_TimeBase模块

**需要手动初始化的模块：**
- OLED模块（需要调用`OLED_Init()`）
- clock_manager模块（需要调用`CLKM_Init()`）
- 其他新增模块（根据模块要求初始化）

### AI工作指南（开工前必读）

**新建会话时：**
1. 粘贴"项目概述"段落作为开场
2. 直接说明新模块需求（如："添加PWM模块驱动电机"）
3. 自动遵循现有代码规范与架构风格
4. 无需重复解释项目结构或历史问题

**核心规则速查（P0规则 - 必须遵守）：**
1. **文件编码**：`.md`文件使用UTF-8编码，`.c/.h`文件使用GB2312编码
   - ⚠️ **重要**：如果`.md`文件的表情符号变成问号或无法识别，必须使用`write`工具直接以UTF-8重新写入完整内容
2. **返回类型**：所有模块函数必须返回`error_code_t`，禁止返回`void`
3. **占位空函数**：必须返回`XXX_ERROR_NOT_IMPLEMENTED`，禁止返回成功码
4. **禁止操作**：
   - ❌ 禁止创建或写入`.uvprojx`文件（只能提示用户复制）
   - ❌ 禁止硬编码寄存器
   - ❌ 禁止跨层调用
   - ❌ 禁止跨模块定义类型
5. **必须操作**：
   - ✅ 检查返回值（所有函数调用）
   - ✅ 参数校验（所有公共函数）
   - ✅ 修改已调试完成的代码前先征询同意

**快速查找规则：**
- 创建模块 → rules/1_topics/stm32.md（模块创建流程）
- 创建案例 → rules/1_topics/examples.md（案例开发流程）
- 规则冲突 → rules/2_reference/faq.md（Q10: 规则冲突时如何处理？）
- 占位空函数 → rules/2_reference/faq.md（Q8: 如何检查占位空函数？）
- 模块位置 → rules/2_reference/faq.md（Q12: 如何判断模块应该放在哪个目录？）

**开工前检查：**
- [ ] 已阅读核心规则（P0规则）
- [ ] 已确定任务类型（创建模块/案例/修改代码）
- [ ] 已查找相关规则（使用目录索引或搜索）
- [ ] 已确认规则优先级（P0 > P1 > P2）

**遇到问题时：**
1. 先查看 rules/2_reference/faq.md（常见问题FAQ）
2. 使用语义搜索查找相关规则
3. 查看 rules/2_reference/quick_reference.md（规则优先级速查）确定优先级
4. 如仍有疑问，询问用户

### 规则标注说明

**规则标注系统**：
- `[通用]` - 适用于所有模块和场景
- `[驱动层]` - 仅适用于驱动层模块
- `[系统层]` - 仅适用于系统服务模块
- `[案例]` - 仅适用于案例代码
- `[可选]` - 推荐但不强制
- `[P0]` - 最高优先级，规则冲突时优先遵守
- `[P1]` - 重要规则，必须遵守
- `[P2]` - 推荐规则，建议遵守

### 快速开始指南

**5分钟快速上手本规范文档：**

1. **理解规则标注系统**
   - 查看规则标注说明了解标注含义
   - `[P0]` = 最高优先级，`[P1]` = 重要规则，`[P2]` = 推荐规则
   - `[通用]` = 适用于所有场景，`[案例]` = 仅适用于案例代码

2. **查找规则的方法**
   - **方法1**：使用目录索引（本文件第5节）快速跳转
   - **方法2**：使用 rules/2_reference/faq.md 查找相关问题
   - **方法3**：使用 rules/2_reference/quick_reference.md 速查
   - **方法4**：使用 rules/2_reference/glossary.md 理解术语

3. **常用规则速查**
   - **命名规范**：见 rules/2_reference/quick_reference.md（命名规范速查表）
   - **检查清单**：见 rules/2_reference/quick_reference.md（模块创建检查清单、案例创建检查清单）
   - **规则优先级**：见 rules/2_reference/quick_reference.md（规则优先级速查）

4. **遇到问题怎么办**
   - 先查看 rules/2_reference/faq.md（常见问题FAQ）
   - 查看相关规则的详细说明
   - 参考 rules/2_reference/glossary.md（术语表）理解术语

5. **开始开发**
   - 创建模块：参考 rules/1_topics/stm32.md（模块创建流程）
   - 创建案例：参考 rules/1_topics/examples.md（案例开发流程）
   - 提交代码：参考 rules/1_topics/stm32.md（提交前检查清单）

**常见场景快速指南**：

**场景1：我要创建一个新模块**
1. 查看 rules/1_topics/stm32.md（模块创建流程）
2. 参考 rules/2_reference/quick_reference.md（模块创建检查清单）
3. 查看 rules/1_topics/stm32.md（目录结构规范）确定模块位置
4. 查看 rules/1_topics/stm32.md（错误处理规范）了解错误码设计
5. 查看 rules/1_topics/stm32.md（模块依赖和解耦规范）了解模块依赖处理

**场景2：我要创建一个新案例**
1. 查看 rules/1_topics/examples.md（案例开发流程）
2. 参考 rules/2_reference/quick_reference.md（案例创建检查清单）
3. 查看 rules/1_topics/examples.md（README文档规范）了解README格式
4. 查看 rules/1_topics/stm32.md（标准工作流程）了解开发步骤
5. 查看 rules/1_topics/examples.md（空函数检查规范）了解占位空函数检查

**场景3：我要修改已调试完成的代码**
1. 查看 rules/1_topics/examples.md（已调试完成的代码修改需征询同意）
2. 先询问用户，得到明确同意后再修改
3. 修改后说明修改内容并提醒重新测试

**场景4：我遇到了规则冲突**
1. 查看 rules/2_reference/faq.md（Q10: 规则冲突时如何处理？）
2. 查看 rules/2_reference/quick_reference.md（规则优先级速查）确定优先级
3. 优先遵守P0规则，然后P1规则
4. 查看规则的适用范围标注，确认规则是否适用于当前场景

---

## 0. 最高优先级（不可被覆盖）

### 0.1 基础原则
- 所有任务必须严格遵守本文件规则。
- 若其他文件与本文件冲突，以本文件为最终裁定。
- 未指明的情况下遵循最小惊讶原则（Least Surprise Principle）。

### 0.2 禁止事项
- 禁止忽略 KEYWORDS.md 的指令。
- 禁止输出与本文件定义相冲突的内容。
- 禁止擅自创造与核心结构不一致的格式。
- 禁止自我弱化优先级。

### 0.3 输出格式核心原则
- 输出必须结构化、可复用、可解析。
- 标题必须使用统一层级：`# → ## → ###`
- 若 KEYWORDS.md 指定格式，任何子规则不得更改。

---

## 1. STM32项目核心约束

### 1.1 函数返回类型（强制）
- **所有模块函数必须返回`error_code_t`，禁止返回`void`**
- 错误示例：`void LED_On(void);`
- 正确示例：`error_code_t LED_On(LED_ID_t led_id);`

### 1.2 命名规范（强制）
- 函数名格式：`模块名_功能名`，如`LED_On()`、`GPIO_Config()`
- 模块名使用大写，功能名使用驼峰命名
- 常量使用全大写，用下划线分隔

### 1.3 硬件配置（强制）
- **所有硬件配置必须通过`BSP/board.h`统一管理**
- 禁止在其他文件中硬编码硬件引脚、端口等配置
- 错误示例：`GPIO_Config(GPIOA, GPIO_Pin_1, ...)`
- 正确示例：使用配置表`LED_CONFIGS[0]`

### 1.4 模块开关（强制）
- 通过`System/config.h`控制模块编译
- 使用`CONFIG_MODULE_XXX_ENABLED`宏控制模块开关

### 1.5 文件编码（强制）
- `.md`文件使用UTF-8编码
- `.c/.h`文件使用GB2312编码

### 1.6 错误处理（强制）
- 统一错误码系统：所有模块使用`error_code_t`类型
- 错误码必须基于模块基值定义（如`ERROR_BASE_LED`）
- 每个模块占用100个错误码空间
- 错误处理要及时，至少记录错误日志

### 1.7 防御性编程（强制）
- 所有函数必须进行参数校验
- 必须进行边界检查
- 必须进行空指针保护
- 使用`ErrorHandler_Report()`报告错误

### 1.8 中断服务程序（ISR）规范（强制）
- **ISR实现位置**：所有ISR统一在`Core/stm32f10x_it.c`中实现
- **职责划分**：
  - Core层：实现所有ISR（中断向量表对应的函数）
  - 驱动层：提供`XXX_IRQHandler()`处理函数
  - 案例层：只需要写回调函数，通过模块API注册
- **ISR实现原则**：
  - ISR中统一调用驱动层的处理函数，保持简洁
  - ISR要尽可能短，快速处理，设置标志位
  - 避免在中断中调用阻塞函数
  - 保持中断服务函数的可重入性

---

## 2. 项目架构约束

### 2.1 分层架构（强制）
- **应用层（Core/）**：主程序入口、中断处理
- **系统服务层（System/）**：delay、clock_manager、system_init等
- **驱动层（Drivers/）**：按类型分类（basic/i2c/spi/display/sensors等）
- **硬件抽象层（BSP/）**：硬件配置隔离
- **标准外设库（Library/、Start/）**：STM32 SPL库

### 2.2 模块依赖（强制）
- 所有驱动模块依赖`BSP/board.h`（硬件配置）
- 大部分模块依赖GPIO（基础模块）
- 中断模式模块依赖NVIC（中断管理）
- 不要在main()中直接操作硬件，必须通过驱动模块

### 2.3 系统初始化（强制）
- `System_Init()`必须在main()开始调用
- 其他模块依赖系统初始化，不要跳过

---

## 3. 代码生成规范

### 3.1 生成新模块时
- 必须返回`error_code_t`类型
- 必须在`Common/error_code.h`中定义模块错误码基值
- 必须在模块头文件中定义错误码枚举
- 必须进行参数校验和防御性编程
- 硬件配置必须从`BSP/board.h`读取

### 3.2 生成文档时
- 使用UTF-8编码
- 标题层级：`# → ## → ###`
- 必须结构化、可扫描
- 包含必要的代码示例

### 3.3 生成示例代码时
- 必须包含错误处理
- 必须使用配置表而非硬编码
- 必须遵循命名规范
- 必须包含必要的注释

---

## 4. 规则优先级体系

1. **本文件（KEYWORDS）**：最高优先级，不可被覆盖
2. **核心规则（0_core）**：标题级核心规则
3. **功能性规则（1_topics）**：功能性规则
4. **参考内容（2_reference）**：参考资料，无约束力

**冲突解决**：若规则冲突，以优先级最高的为准。

---

## 5. 目录索引（按主题快速访问）

### 5.1 标题级核心规则（高优先级）
- 写作核心 → rules/0_core/writing.mdc（或 writing.md）
- 文档结构 → rules/0_core/structure.mdc（或 structure.md）
- 优先级系统 → rules/0_core/priority.mdc（或 priority.md）

### 5.2 功能性规则（中优先级）
- STM32项目特定规则 → rules/1_topics/stm32.mdc（或 stm32.md）
- 技术写作 → rules/1_topics/tech.mdc（或 tech.md）
- 通用文案风格 → rules/1_topics/style.mdc（或 style.md）
- 错误处理 → rules/1_topics/error.mdc（或 error.md）
- 案例创建规范 → rules/1_topics/examples.mdc（或 examples.md）

### 5.3 参考内容（低优先级）
- Markdown样例 → rules/2_reference/markdown.mdc（或 markdown.md）
- 示例文档 → rules/2_reference/examples.mdc（或 examples.md）
- 常见问题FAQ → rules/2_reference/faq.md
- 术语表 → rules/2_reference/glossary.md
- 快速参考卡片 → rules/2_reference/quick_reference.md

**注意**：每个规则文件都有两个版本：
- `.md` 文件：文档格式，用于阅读和编辑
- `.mdc` 文件：Cursor规则格式，用于 Cursor IDE 加载
